{"createdAt":"2025-11-11T03:36:20.269Z","updatedAt":"2025-11-11T03:36:20.269Z","id":"5c0WouGXNRQdCczS","name":"SEGUIMIENTO WHATSAPP WAAPI","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours","hoursInterval":6}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0],"id":"5bc23d28-d7b7-4789-947f-fdbbc0ebb35a","name":"Schedule Trigger"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nFROM (\n  SELECT *\n  FROM public.n8n_chat_histories\n  WHERE session_id = '{{ $json.session_id }}'\n  ORDER BY id DESC\n  LIMIT 10\n) AS sub\nORDER BY id ASC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1168,368],"id":"4f8d57b4-e6d4-41ea-ac90-fed081835c72","name":"Postgres","onError":"continueRegularOutput"},{"parameters":{"jsCode":"const items = $input.all();\n\nitems.sort((a, b) => a.json.id - b.json.id);\n\nconst mensajesFormateados = items.map(item => {\n  const tipo = item.json.message.type;\n  const contenido = item.json.message.content;\n\n  if (tipo === 'human') {\n    return `ðŸ‘¤ Humano: ${contenido}`;\n  } else if (tipo === 'ai') {\n    return `ðŸ¤– IA: ${contenido}`;\n  } else {\n    return `ðŸ”¸ Otro: ${contenido}`;\n  }\n});\n\nreturn [\n  {\n    json: {\n      contexto_chat: mensajesFormateados.join('\\n\\n')\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1168,608],"id":"58a88232-a579-4a4d-bea5-2a94082d89ea","name":"Code2","onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"/* Trae SOLO el Ãºltimo mensaje de cada sesiÃ³n cuyo autor sea el bot\n   y que aÃºn tenga follow-ups pendientes (attempts < 2) */\nWITH ult AS (\n  SELECT h.*,\n         ROW_NUMBER() OVER (PARTITION BY session_id ORDER BY id DESC) AS rn\n  FROM   public.n8n_chat_histories h\n)\nSELECT\n    id,\n    session_id,\n    message->>'content'     AS texto,\n    followup_attempts,      -- 0 Ã³ 1\n    created_at\nFROM   ult\nWHERE  rn = 1\n  AND  message->>'type' IN ('assistant','ai','robot')\n  AND  created_at >= NOW() - INTERVAL '24 hours'  -- aÃºn en ventana IG\n  AND  followup_attempts < 2                      -- 0 = FU-1, 1 = FU-2\n  AND  NOT EXISTS (                               -- usuario no respondiÃ³\n        SELECT 1\n        FROM   public.n8n_chat_histories h2\n        WHERE  h2.session_id = ult.session_id\n          AND  h2.id        > ult.id\n          AND  h2.message->>'type' = 'human'\n      )\nORDER  BY created_at ASC;      -- (opcional) mÃ¡s viejos primero\n","options":{"replaceEmptyStrings":false}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[368,0],"id":"a5bf9a97-9710-41d1-bbb5-2ed40361d64f","name":"Postgres1","credentials":{"postgres":{"id":"H8BZiMyQn9N1EgIv","name":"Postgres account"}},"onError":"continueRegularOutput"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.followup_attempts }}","rightValue":0,"operator":{"type":"number","operation":"equals"},"id":"685faa97-2342-4870-b7fe-0de96073ae63"}],"combinator":"and"},"renameOutput":true,"outputKey":"PRIMER SEGUIMIENTO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2f22ced1-50a9-417c-8e60-f5c0ae8b8d2f","leftValue":"={{ $json.followup_attempts }}","rightValue":1,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"SEGUNDO SEGUIMIENTO"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[32,288],"id":"97eeab56-2ec1-4033-8867-eedf9b75d38b","name":"Switch1"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[528,288],"id":"c6ef0113-88e2-47d2-9911-f301be68634d","name":"Loop Over Items"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"GPT-4.1-NANO"},"messages":{"values":[{"content":"=Eres un asistente de WhatsApp/Instagram.\nDevuelve SÃ“LO un objeto JSON con esta estructura (sin texto extra, sin saltos antes ni despuÃ©s):\n\n{\n  \"respuesta\": \"SI\" | \"NO\",\n  \"mensaje\": \"...si respuesta es SI, aquÃ­ pones el follow-up en 1-2 frases...\"\n}\nObjetivo\nAnalizar toda la conversaciÃ³n completa y decidir si vale la pena enviar un mensaje de seguimiento breve y natural.\n\nCriterios para \"respuesta\": \"SI\"\nEl Ãºltimo mensaje visible para el usuario lo enviÃ³ el bot y el usuario no ha contestado.\n\nQuedÃ³ una pregunta, interÃ©s, CTA o duda abierta (ej. â€œÂ¿precio?â€, â€œcuÃ©ntame mÃ¡sâ€, â€œme interesaâ€).\n\nCriterios para \"respuesta\": \"NO\"\nEl Ãºltimo mensaje del bot fue solo cortesÃ­a o cierre (â€œgraciasâ€, â€œquedo atentoâ€).\n\nEl usuario ya declinÃ³ o pidiÃ³ no recibir mÃ¡s mensajes.\n\nReglas para \"mensaje\" (solo si \"respuesta\":\"SI\")\n1 â€“ 2 frases, tono cercano y profesional.\n\nPuedes hacer referencia a la Ãºltima pregunta o tema para sonar natural.\n\nNo uses emojis ni texto promocional agresivo; solo apoya y ofrece ayuda.\n\nEjemplos vÃ¡lidos:\n\nâ€œÂ¡Hola de nuevo! Solo querÃ­a saber si te quedÃ³ alguna duda sobre los planes y precios. Estoy aquÃ­ para ayudarte.â€\n\nâ€œPaso rÃ¡pido antes de que se cierre el chat de 24 h. Â¿Te gustarÃ­a que agendemos una llamada o te envÃ­o mÃ¡s info?â€\n\nRecuerda: responde Ãºnicamente el JSON EXACTO acorde al esquema, sin comentarios ni campos extra.\n\n\nPara que tengas contexto de que intento de seguimiento es te voy a dar el numero de seguimiento\n\n0 = No se le ha mandado seguimiento\n1 = Se le mando un seguimiento y no respondio aun","role":"system"},{"content":"=ConversaciÃ³n Completa:  {{ $json.contexto_chat }}\n\nNÃºmero de seguimiento: {{ $json.followup_attempts }}"}]},"simplify":"={{ true }}","jsonOutput":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1472,832],"id":"3e8daaf0-ecda-463a-b8ce-0a21dcfc0a66","name":"OpenAI3"},{"parameters":{"assignments":{"assignments":[{"id":"a6fe9975-af15-4fe8-8efe-c9c7ad8eb9a6","name":"id","value":"={{ $json.id }}","type":"number"},{"id":"ef56298b-cb84-44c5-8e01-d08ed916e740","name":"session_id","value":"={{ $json.session_id }}","type":"string"},{"id":"41b7d4a1-a87d-4798-8aef-7eeb30525246","name":"texto","value":"={{ $json.texto }}","type":"string"},{"id":"291b1d83-3a5c-4575-bad3-970877490305","name":"followup_attempts","value":"={{ $json.followup_attempts }}","type":"number"},{"id":"9a5beb19-a18c-438a-b82a-a936fb1f3b8e","name":"created_at","value":"={{ $json.created_at }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[800,384],"id":"d173aeca-7d7b-4761-8426-fbd318f0e7b8","name":"Edit Fields1"},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1168,832],"id":"8604f1fd-3b96-4c08-9f1a-f8a7ef95a9d5","name":"Merge"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"016e0e36-7083-469b-b951-108bf1408638","leftValue":"={{ $json.followup_attempts }}","rightValue":1,"operator":{"type":"number","operation":"lte"}},{"id":"67ccaae3-d594-458e-b205-4f5b0b2fe6f7","leftValue":"={{ $json.session_id }}","rightValue":"c.us","operator":{"type":"string","operation":"contains"}},{"id":"0024653c-b5e2-489f-bd97-30b47534ba10","leftValue":"={{ $json.created_at }}","rightValue":"={{ $now.minus({ hours: 14, minutes: 55 }).toISO() }}","operator":{"type":"dateTime","operation":"after"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-224,288],"id":"a014a40e-62a8-46e8-b62e-6f89fc9e15c3","name":"Filter"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d61ad96f-fdc1-4c6d-990b-e15e438d4d37","leftValue":"={{ $json.message.content.respuesta }}","rightValue":"SI","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1904,832],"id":"5c90967e-f8da-49f8-954b-fc65c4c0c6c5","name":"If"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Edit Fields1').item.json.id }}","followup_attempts":2},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"followup_sent_at","displayName":"followup_sent_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"followup_attempts","displayName":"followup_attempts","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2224,928],"id":"20342361-57de-40c6-96ab-3ffd67ccaa2b","name":"Postgres5"},{"parameters":{"method":"POST","url":"https://api.manychat.com/fb/sending/sendContent","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"subscriber_id\": {{ $json.ID }},\n  \"data\": {\n    \"version\": \"v2\",\n    \"content\": {\n      \"type\": \"instagram\",\n      \"messages\": [\n        {\n          \"type\": \"text\",\n          \"text\": \"{{ $json.MENSAJE }}\"\n        }\n      ]\n    }\n  },\n  \"message_tag\": \"ACCOUNT_UPDATE\"\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2720,688],"id":"e0a3127b-a138-4469-af39-72e5361edd3e","name":"HTTP Request1"},{"parameters":{"assignments":{"assignments":[{"id":"ac035add-dddb-4130-94b7-12b96d3ef786","name":"MENSAJE","value":"={{ $json.message.content.mensaje }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2144,704],"id":"7a2673fd-a4cc-4b45-a4bf-801ac64bd27f","name":"Edit Fields3"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Edit Fields1').item.json.id }}","followup_attempts":1},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"followup_sent_at","displayName":"followup_sent_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"followup_attempts","displayName":"followup_attempts","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2608,1008],"id":"b0a8364f-5b4e-4b4a-8a2a-f3d043c7b74e","name":"Postgres6"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nFROM (\n  SELECT *\n  FROM public.n8n_chat_histories\n  WHERE session_id = '{{ $json.session_id }}'\n  ORDER BY id DESC\n  LIMIT 10\n) AS sub\nORDER BY id ASC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1168,1312],"id":"c18daab5-1f2e-47f5-b662-503364ae52be","name":"Postgres4","onError":"continueRegularOutput"},{"parameters":{"jsCode":"const items = $input.all();\n\nitems.sort((a, b) => a.json.id - b.json.id);\n\nconst mensajesFormateados = items.map(item => {\n  const tipo = item.json.message.type;\n  const contenido = item.json.message.content;\n\n  if (tipo === 'human') {\n    return `ðŸ‘¤ Humano: ${contenido}`;\n  } else if (tipo === 'ai') {\n    return `ðŸ¤– IA: ${contenido}`;\n  } else {\n    return `ðŸ”¸ Otro: ${contenido}`;\n  }\n});\n\nreturn [\n  {\n    json: {\n      contexto_chat: mensajesFormateados.join('\\n\\n')\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1168,1552],"id":"67772472-96cd-4888-b02f-e42ca6eec8df","name":"Code","onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[528,1232],"id":"a6d200fc-1235-47e9-98e3-e7398ef60dd3","name":"Loop Over Items2"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4.1-nano","mode":"list","cachedResultName":"GPT-4.1-NANO"},"messages":{"values":[{"content":"=Eres un asistente especializado en el segundo seguimiento para mensajes de Instagram/WhatsApp.\nDevuelve EXCLUSIVAMENTE un objeto JSON con este formato (sin ningÃºn texto adicional):\n\n\n{\n  \"respuesta\": \"SI\" | \"NO\",\n  \"mensaje\": \"â€¦solo si respuesta es SI, redacta aquÃ­ de 1-2 frasesâ€¦\"\n}\n\nCriterios para \"respuesta\": \"SI\"\nhoras_desde_usuario â‰¤ 24 (seguimos dentro de la ventana de 24 h).\n\nhoras_desde_fu1 â‰¥ 17 (han pasado al menos 17 h desde FU-1).\n\nEl usuario no ha respondido despuÃ©s de FU-1.\n\nEl mensaje anterior del bot (FU-1) dejÃ³ clara la invitaciÃ³n a continuar, pero quedÃ³ sin respuesta o con una pregunta abierta.\n\nCriterios para \"respuesta\": \"NO\"\nEl usuario respondiÃ³ tras FU-1 o indicÃ³ que no desea mÃ¡s mensajes.\n\nhoras_desde_usuario > 24 (fuera de la ventana) o horas_desde_fu1 < 17 (aÃºn es pronto).\n\nSe detecta desinterÃ©s (â€œgraciasâ€, â€œlo pensarÃ©â€, silencio tras rechazo).\n\nReglas para el campo \"mensaje\" (solo si \"respuesta\" = \"SI\")\n1-2 frases, tono cordial y breve.\n\nRefuerza la idea de que la ventana de 24 h estÃ¡ por cerrar (â€œantes de que se cierre el chatâ€¦â€).\n\nMenciona de forma natural el tema pendiente: precio, reserva, llamada, etc.\n\nCero emojis y nada agresivo; solo Ãºtil y cercano.\n\nEjemplos de mensajes vÃ¡lidos\nâ€œAntes de que se cierre la conversaciÃ³n de 24 h, Â¿te gustarÃ­a que agendemos una llamada o te pase mÃ¡s detalles?â€\n\nâ€œPaso rÃ¡pido para ver si aÃºn quieres avanzar; si necesitas algo mÃ¡s, dime y con gusto te ayudo.â€\n\nIMPORTANTE: responde exactamente el JSON solicitado. No aÃ±adas comentarios, campos extra ni texto fuera del objeto JSON.","role":"system"},{"content":"=ConversaciÃ³n Completa:  {{ $json.contexto_chat }}\n\nNÃºmero de seguimiento: {{ $json.followup_attempts }}"}]},"simplify":"={{ true }}","jsonOutput":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1472,1760],"id":"82a3e855-389c-49b6-9703-20bbb677cd4d","name":"OpenAI"},{"parameters":{"assignments":{"assignments":[{"id":"a6fe9975-af15-4fe8-8efe-c9c7ad8eb9a6","name":"id","value":"={{ $json.id }}","type":"number"},{"id":"ef56298b-cb84-44c5-8e01-d08ed916e740","name":"session_id","value":"={{ $json.session_id }}","type":"string"},{"id":"41b7d4a1-a87d-4798-8aef-7eeb30525246","name":"texto","value":"={{ $json.texto }}","type":"string"},{"id":"291b1d83-3a5c-4575-bad3-970877490305","name":"followup_attempts","value":"={{ $json.followup_attempts }}","type":"number"},{"id":"9a5beb19-a18c-438a-b82a-a936fb1f3b8e","name":"created_at","value":"={{ $json.created_at }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[800,1328],"id":"e9895243-d9b5-488e-8705-e318229a36ae","name":"Edit Fields"},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1168,1760],"id":"4f766520-81e7-4860-bd1f-83ff4b066739","name":"Merge2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d61ad96f-fdc1-4c6d-990b-e15e438d4d37","leftValue":"={{ $json.message.content.respuesta }}","rightValue":"SI","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1904,1760],"id":"af371000-74cb-44e8-9c58-b68dc29761c4","name":"If1"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Edit Fields').item.json.id }}","followup_attempts":2},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"followup_sent_at","displayName":"followup_sent_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"followup_attempts","displayName":"followup_attempts","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2224,1872],"id":"67fe9673-8e17-4ff8-8568-770d6d78d40a","name":"Postgres7"},{"parameters":{"assignments":{"assignments":[{"id":"ac035add-dddb-4130-94b7-12b96d3ef786","name":"MENSAJE","value":"={{ $json.message.content.mensaje }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2144,1648],"id":"4aacfdb7-a43c-4819-9e79-b2aa5fa9edf5","name":"Edit Fields4"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Edit Fields').item.json.id }}","followup_attempts":2},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"followup_sent_at","displayName":"followup_sent_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"followup_attempts","displayName":"followup_attempts","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2608,1952],"id":"3be8eab0-1103-416e-b814-21fdc0a5cf9c","name":"Postgres8"},{"parameters":{"method":"POST","url":"https://waapi.app/api/v1/instances/64776/client/action/send-message","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"chatId","value":"={{ $('Edit Fields1').item.json.session_id }}"},{"name":"message","value":"={{ $json.MENSAJE }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2432,592],"id":"92576434-e833-4c75-b967-0e469106cf8e","name":"TEXTO"},{"parameters":{"method":"POST","url":"https://waapi.app/api/v1/instances/64776/client/action/send-message","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"chatId","value":"={{ $('Edit Fields').item.json.session_id }}"},{"name":"message","value":"={{ $json.MENSAJE }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2320,1472],"id":"741b2199-533d-4bf7-97f5-3d3e0df1e899","name":"TEXTO1"}],"connections":{"Schedule Trigger":{"main":[[{"node":"Postgres1","type":"main","index":0}]]},"Postgres":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Postgres1":{"main":[[{"node":"Filter","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Edit Fields1","type":"main","index":0}]]},"OpenAI3":{"main":[[{"node":"If","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Postgres","type":"main","index":0},{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"OpenAI3","type":"main","index":0}]]},"Filter":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}],[{"node":"Loop Over Items2","type":"main","index":0}]]},"If":{"main":[[{"node":"Edit Fields3","type":"main","index":0}],[{"node":"Postgres5","type":"main","index":0}]]},"Edit Fields3":{"main":[[{"node":"TEXTO","type":"main","index":0}]]},"Postgres5":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Postgres6":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Postgres4":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Merge2","type":"main","index":0}]]},"Loop Over Items2":{"main":[[],[{"node":"Edit Fields","type":"main","index":0}]]},"OpenAI":{"main":[[{"node":"If1","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Postgres4","type":"main","index":0},{"node":"Merge2","type":"main","index":1}]]},"Merge2":{"main":[[{"node":"OpenAI","type":"main","index":0}]]},"If1":{"main":[[{"node":"Edit Fields4","type":"main","index":0}],[{"node":"Postgres7","type":"main","index":0}]]},"Postgres7":{"main":[[{"node":"Loop Over Items2","type":"main","index":0}]]},"Edit Fields4":{"main":[[{"node":"TEXTO1","type":"main","index":0}]]},"Postgres8":{"main":[[{"node":"Loop Over Items2","type":"main","index":0}]]},"TEXTO":{"main":[[{"node":"Postgres6","type":"main","index":0}]]},"TEXTO1":{"main":[[{"node":"Postgres8","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"491e505c-ad77-4fbc-a14f-203bfb20246a","triggerCount":0,"tags":[{"createdAt":"2025-11-10T17:52:47.997Z","updatedAt":"2025-11-10T17:52:47.997Z","id":"XBwwjnkaDrN3oI0V","name":"MAIN"}],"shared":[{"createdAt":"2025-11-20T18:17:54.888Z","updatedAt":"2025-11-20T18:17:54.888Z","role":"workflow:owner","workflowId":"5c0WouGXNRQdCczS","projectId":"hjSKGjfHqbYgbRJl","project":{"createdAt":"2025-11-20T16:08:16.301Z","updatedAt":"2025-11-20T17:01:47.741Z","id":"hjSKGjfHqbYgbRJl","name":"Presla Corp <svargas@presla.co>","type":"personal","icon":null,"description":null}}]}