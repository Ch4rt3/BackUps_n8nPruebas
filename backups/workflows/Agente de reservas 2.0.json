{"createdAt":"2025-11-17T14:37:14.118Z","updatedAt":"2025-11-17T14:37:22.308Z","id":"rM9HYRJvNSVOv9uX","name":"Agente de reservas 2.0","active":false,"isArchived":false,"nodes":[{"parameters":{"promptType":"define","text":"=Mensaje del usuario: {{ $('Redis').item.json.response }}\nEl numero de telefono del usuario es:{{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}","options":{"systemMessage":"=## 1. DEFINICIÃ“N DE IDENTIDAD\nEres un **asistente de reservas** para **Estudio ClÃ­nica Dental**.  \nTu rol es atender a los clientes respondiendo preguntas frecuentes y gestionando reservas, modificaciones y cancelaciones de citas.\n\n---\n\n## 2. HERRAMIENTAS DISPONIBLES\n\n- **think**  \n  Usar esta herramienta SIEMPRE. Resume mentalmente el problema y planifica la respuesta.\n\n- **conocimiento**  \n  Usar siempre para responder cualquier pregunta o duda que tenga el cliente respecto al negocio, horarios, servicios o consultas.\n\n- **buscar_usuario**:busca al usuario en la base de datos para verificar si esta registrado en el crm.\n\n- **registrar_usuario**: si el usuario no existe en el CRM debes registrarlo\n\n- **reservar_cita**  \n  Para reservar la cita una vez validada la fecha y hora.\n\n- **comprobar_fecha**:\n  Para comprobar la fecha antes de reservar.\n\n- **modificar_cita**  \n  Para modificar citas agendadas.\n\n- **cancelar_cita**  \n  Para cancelar citas agendadas.\n\n- **derivar_humano**  \n  Para derivar a asesor humano cuando se necesite ayuda extra o el cliente lo requiera.\n\n---\n\n## 3. OBJETIVO PRINCIPAL\nEl propÃ³sito principal del agente es **realizar las reservas de manera efectiva**, liberando tiempo a los empleados y asegurando una atenciÃ³n rÃ¡pida y precisa a los clientes.\n\n---\n\n## 4. INSTRUCCIONES ESPECÃFICAS\n- Verificar si el usuario existe en el CRM con \"buscar_usuario\".\n- Si el usuario existe preguntale que desea realizar.\n- Si el usuario no existe, preguntale su nombre y apellido y registralo en el CRM con \"registrar_usuario\", luego pregunta que desea realizar.\n\n- Para **reservar una cita**:\n  - Pregunta siempre al usuario la **fecha y hora** en que desea su cita.\n  - Es sumamente importante que recibas siempre la FECHA y HORA. Si solo recibes la fecha, pregunta por la hora.\n  - Es obligatorio usar `comprobar_fecha` antes de realizar la reserva.\n\n  - Si la fecha es vÃ¡lida, utiliza `reservar_cita` para agendarla.\n  - Entrega los datos de la cita agendada,incluir emojis:\n\n     -ðŸ“… Fecha: (colocar fecha)\n     -ðŸ“ Link meet:(colocar link)\n\n- Para **modificar una cita**:\n  - Pregunta al usuario la **fecha y hora actual de su cita**.\n  - Pregunta para cuÃ¡ndo desea **cambiar su cita** (nueva fecha y hora).\n  - Es sumamente importante que recibas siempre la FECHA y HORA. Si solo recibes la fecha, pregunta por la hora.\n  -Utiliza `modificar_cita` para proceder con la modificacion. \n\n  - Entrega los datos de la cita modificada,incluir emojis:\n\n     -ðŸ“… Fecha nueva cita: (colocar fecha nueva cita)\n     -ðŸ“ Link meet:(colocar link)\n\n- Para **cancelar una cita**:\n  - Pregunta al usuario la **fecha y hora actual** de la cita que desea cancelar.\n  - Utiliza `cancelar_cita` para proceder con la cancelaciÃ³n.\n\n- Usa `conocimiento` para responder cualquier duda sobre horarios, servicios, consultas o informaciÃ³n general del negocio.\n\n- Antes de responder o ejecutar cualquier acciÃ³n, utiliza `think` para organizar y planificar tu respuesta.\n\n- SÃ© amable, claro y breve en tus respuestas.\n\n- Para las fechas siempre utilizar el formato ISO sin zona horaria\n\n- Para **derivar atencion a un asesor**: deriva atencion a un asesor cuando el cliente necesite ayuda extra\n\n## 5. NOTAS IMPORTANTES PARA TI.\n\n- Usa \"think\" siempre antes de actuar\n- Si es un servicio oficial llama a \"conocimiento\" con el nombre exacto\n- Si es una pregunta llama a \"conocimiento\" con la frase textual del cliente\n- Nunca agendes nada sin verificar antes la fecha\n- Nunca agendes sin antes recibir la fecha y hora\n- Siempre cierra con una actitud cÃ¡lida, profesional y empÃ¡tica\n- Por favor evita usar ni incluir asteriscos ni comillas.\n- AsegÃºrate de que tu mensaje sea breve y directo, sin usar saltos de lÃ­nea.\n- La fecha de hoy es {{ $now }}\n- Es importante manejar las fechas en formato ISO sin zona horaria\n- Para hacer las reservas siempre debes recibir la fecha y hora soliticada. Si recibes solo la fecha pregunta porfavor que te digan la hora.\n-Si el cliente no se acuerda del horario de su fecha, dale la opcion de derivar a un asesor para ser atendido.\n\n\n\n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.7,"position":[2528,208],"id":"8d1b787b-7d10-4e6b-baaf-60f2fc76d6e4","name":"AI Agent"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[2432,528],"id":"06efc1f5-c5c3-4c3a-ba84-4bc8e6a40a43","name":"Postgres Chat Memory"},{"parameters":{"description":"Herramienta para reflexionar y planificar antes de responder. Ãšsala siempre para analizar el contexto, entender la intenciÃ³n del usuario y decidir los prÃ³ximos pasos."},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1,"position":[2544,560],"id":"4b44e404-8545-4009-afe3-377f8bbf21de","name":"Think"},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"Herramienta para responder a preguntas del usuario.","tableName":{"__rl":true,"value":"documents","mode":"list","cachedResultName":"documents"},"options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStoreSupabase","typeVersion":1.3,"position":[2384,720],"id":"84681a8c-41f3-4f90-b1b0-ecf340431906","name":"conocimiento"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[2432,1008],"id":"6cdb297d-581a-4c3e-9154-ded238e269aa","name":"Embeddings OpenAI"},{"parameters":{"description":"LLama a esta tool para realizar las reservas del cliente.","workflowId":{"__rl":true,"value":"yMquJf73EOJ7K6LE","mode":"list","cachedResultName":"reservar_citas_clinica"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Fecha":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Fecha', `Fecha en formato ISO sin zona horaria, ejemplo:\n2025-07-09T15:30:00`, 'string') }}","Telefono":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}","Nombre":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Nombre', `Nombre del usuario`, 'string') }}"},"matchingColumns":["Fecha"],"schema":[{"id":"Fecha","displayName":"Fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2960,512],"id":"a08e06e7-63a6-472a-86b7-54b54e474ec0","name":"reservar_cita"},{"parameters":{"description":"Herramienta encargada de comprobar las fechas ingresadas","workflowId":{"__rl":true,"value":"8DneNaUdQhPmc1am","mode":"list","cachedResultName":"comprobar_fecha_clinica"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Fecha":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Fecha', `Fecha en formato ISO sin zona horaria, ejemplo:\n2025-07-09T15:30:00\n`, 'string') }}"},"matchingColumns":["Fecha"],"schema":[{"id":"Fecha","displayName":"Fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2864,544],"id":"502158cd-99e5-4374-92bf-0b415a4524f4","name":"comprobar_fecha"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"caf542fe-bc18-4389-b681-4bcf16c85bf8","leftValue":"={{ $json.body.message_type }}","rightValue":"incoming","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-784,304],"id":"91247c30-b0ac-42f8-b41b-91158ae61278","name":"If1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-576,512],"id":"558b642d-3382-4f07-8950-3dd828dafbd3","name":"No Operation, do nothing"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8ab13a4b-c606-48d6-a1f9-23f4fe51c347","leftValue":"={{ $json.body.conversation.messages[0].sender.custom_attributes.bot_off }}","rightValue":"bot off","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-528,288],"id":"b2614b22-458a-467e-a537-5c9fdc26fdc1","name":"If2"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.body.conversation.messages[0].attachments[0].file_type }}","rightValue":"audio","operator":{"type":"string","operation":"equals"},"id":"3d7bf356-e75d-43a7-958e-b731bde14a5f"}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c44ac4d2-6462-470d-882b-0dbb3db98840","leftValue":"={{ $json.body.conversation.messages[0].attachments[0].file_type }}","rightValue":"image","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Imagen"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d190e0e5-43ac-4a8b-8871-59bd6b2b484e","leftValue":"={{ $json.body.conversation.messages[0].content_type }}","rightValue":"text","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"}]},"options":{"fallbackOutput":"extra","renameFallbackOutput":"Otro"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-304,272],"id":"dcea1fda-d60d-4cdd-91fb-60eb09d95605","name":"Switch"},{"parameters":{"url":"={{ $json.body.conversation.messages[0].attachments[0].data_url }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"id":"9a11c1f3-0101-419f-bf81-fc508cccd4e5","name":"get audio"},{"parameters":{"url":"={{ $json.body.conversation.messages[0].attachments[0].data_url }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[32,224],"id":"57da9f9c-ef62-4b03-a501-6ce51b06e74a","name":"get image"},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[288,0],"id":"16633f83-6794-4f07-8e94-759facf5973e","name":"OpenAI1"},{"parameters":{"assignments":{"assignments":[{"id":"ab3e1c44-9a2c-48d7-a5d2-41339a74c99e","name":"content","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[544,0],"id":"5154d14f-d7f0-4838-96b1-6f2fa8ad47e7","name":"audio content1"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"chatgpt-4o-latest","mode":"list","cachedResultName":"CHATGPT-4O-LATEST"},"text":"Describe la imagen lo mejor posible.","inputType":"base64","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[288,224],"id":"79414a32-3bec-49d4-b6b4-ee58ec0daa4a","name":"describe image1"},{"parameters":{"assignments":{"assignments":[{"id":"ab3e1c44-9a2c-48d7-a5d2-41339a74c99e","name":"content","value":"={{ $json.content }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[560,224],"id":"f364d4c6-d66e-4a90-bc5b-cd4390a506e2","name":"imagen content1"},{"parameters":{"assignments":{"assignments":[{"id":"167b012f-c39d-456c-be8e-6e26462ef70e","name":"content","value":"={{ $json.body.content }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[288,464],"id":"62fb2008-0def-4ecf-9c86-b4ac471341a1","name":"text content1"},{"parameters":{"operation":"delete","key":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2304,208],"id":"92e34831-bafb-49a7-9dd1-45c942fd73dd","name":"Redis"},{"parameters":{"assignments":{"assignments":[{"id":"d5f82380-4858-4361-908e-98e45c98f092","name":"response","value":"={{ $('Redis10').item.json.mensajes.join() }}","type":"string"},{"id":"b3db797c-6f2b-4232-8e0c-021bc8e299ca","name":"phone","value":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2112,208],"id":"8b92768e-4317-4ba9-87be-3834970b6939","name":"Edit Fields"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2048,400],"id":"09fb1f2a-8ecd-4d2a-bcea-a6ba3ab51b76","name":"No Operation, do nothing2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8a313a41-eadc-4ada-bc2a-feff79845de9","leftValue":"={{ $json.mensajes.last() }}","rightValue":"={{ $('texto final').item.json.chat_input }}","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1840,224],"id":"41c9b5b1-3525-4284-961e-f655c6d2ffaf","name":"If"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1360,224],"id":"e8951690-9973-472e-bf94-6878c48c4394","name":"Wait","webhookId":"0a64e419-6904-4df8-a1c6-f00757e58bf3"},{"parameters":{"operation":"push","list":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}","messageData":"={{ $json.chat_input }}","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1120,224],"id":"e25e2e51-c194-4265-9df3-10845889530c","name":"Redis8"},{"parameters":{"operation":"get","propertyName":"mensajes","key":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1632,224],"id":"a761e614-3aa5-4e9c-914c-e81c0390ef70","name":"Redis10"},{"parameters":{"method":"POST","url":"=https://devchatwoot.iacondiego.es/api/v1/accounts/1/conversations/{{ $('Webhook').item.json.body.conversation.messages[0].conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"gCwFAc6nj7kGQMMbfGM1c1rD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $json.output }}"},{"name":"private","value":"false"},{"name":"message_type","value":"outgoing"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2912,208],"id":"9e8e0ea0-0cb5-49f3-a61f-50b325549b03","name":"Enviar mensaje chatwoot","executeOnce":false},{"parameters":{"description":"LLama a esta herramienta para modificar citas.","workflowId":{"__rl":true,"value":"iL35xBWD1PoDppd2","mode":"list","cachedResultName":"modificar_cita_clinica"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Nombre":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.name }}","Telefono":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}","Fecha actual":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Fecha_actual', `Fecha actual de la cita en formato ISO sin zona horaria, ejemplo:\n2025-07-09T15:30:00\n`, 'string') }}","Fecha nueva":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Fecha_nueva', `Fecha nueva de la cita en formato ISO sin zona horaria, ejemplo:\n2025-07-13T15:30:00`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"Fecha actual","displayName":"Fecha actual","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Fecha nueva","displayName":"Fecha nueva","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[3072,464],"id":"a1472246-0350-47da-8abf-42185e716fc4","name":"modificar_cita"},{"parameters":{"description":"LLama a esta herramienta cuando el cliente requiera atencion extra o quiere ser atendido por un humano.","workflowId":{"__rl":true,"value":"05xdPsQ8HLA37JQK","mode":"list","cachedResultName":"enviar_asesor"},"workflowInputs":{"mappingMode":"defineBelow","value":{"conversation id":"={{ $('Webhook').item.json.body.conversation.messages[0].conversation_id }}","contact id":"={{ $('Webhook').item.json.body.conversation.contact_inbox.contact_id }}"},"matchingColumns":[],"schema":[{"id":"conversation id","displayName":"conversation id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"contact id","displayName":"contact id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[3312,320],"id":"b2238099-8349-40df-8422-939cb6b9a21d","name":"enviar_asesor"},{"parameters":{"description":"LLama a esta herramienta para cancelar la cita.","workflowId":{"__rl":true,"value":"iPz0y9CMaVvnIO0t","mode":"list","cachedResultName":"cancelar_cita"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Fecha":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Fecha', `Fecha la cual quiere ser eliminada en formato ISO sin zona horaria, ejemplo:\n2025-07-09T15:30:00`, 'string') }}","Telefono":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}"},"matchingColumns":[],"schema":[{"id":"Fecha","displayName":"Fecha","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[3184,400],"id":"843adc8c-0408-4a9a-a29e-706ca47baddd","name":"cancelar_cita"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e4226e1c-d47a-466e-a4d6-0b7bedddbcc5","leftValue":"={{ $json.summary }}","rightValue":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[1184,1072],"id":"d0148247-88fa-4e41-bb35-748a0c8fd75b","name":"Obtener ID"},{"parameters":{"operation":"update","calendar":{"__rl":true,"value":"iacondiegov@gmail.com","mode":"list","cachedResultName":"iacondiegov@gmail.com"},"eventId":"={{ $json.id }}","updateFields":{"summary":"=ðŸŸ¢{{ $json.summary }}"}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[1408,1072],"id":"cf959461-a094-40f9-b04d-013062dd4e1d","name":"Google Calendar1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e4226e1c-d47a-466e-a4d6-0b7bedddbcc5","leftValue":"={{ $json.summary }}","rightValue":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[1200,784],"id":"6828ea00-e334-451e-ab3c-7c177d0ad0a8","name":"Obtener ID1"},{"parameters":{"httpMethod":"POST","path":"537662ba-0067-404d-b68a-6436f80309c7","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1056,304],"id":"847a7cf9-7849-4b57-9dfe-8d6f113379ec","name":"Webhook","webhookId":"537662ba-0067-404d-b68a-6436f80309c7"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.body.content }}","rightValue":"/No podrÃ© asistir","operator":{"type":"string","operation":"equals"},"id":"1709fd6a-25e1-43eb-9ee0-3631a035ea61"}],"combinator":"and"},"renameOutput":true,"outputKey":"Cancela cita"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7007be59-2587-4754-8da8-34504f5e452c","leftValue":"={{ $json.body.content }}","rightValue":"/Si confirmo cita","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Confirma cita"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[400,928],"id":"e87c7642-dd0a-4139-bc9a-6d32c02685c1","name":"Switch1"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"iacondiegov@gmail.com","mode":"list","cachedResultName":"iacondiegov@gmail.com"},"limit":20,"timeMin":"={{$now}}","timeMax":"={{ $now.plus({ day: 1 }) }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[992,784],"id":"0316b520-3ffd-478a-bf5d-90574f1fe58c","name":"Get many events"},{"parameters":{"operation":"delete","calendar":{"__rl":true,"value":"iacondiegov@gmail.com","mode":"list","cachedResultName":"iacondiegov@gmail.com"},"eventId":"={{ $json.id }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[1424,784],"id":"f3a0c399-be7c-4da7-bc24-35645d1439a1","name":"Delete an event"},{"parameters":{"method":"POST","url":"=https://devchatwoot.iacondiego.es/api/v1/accounts/1/conversations/{{ $('Webhook').item.json.body.conversation.messages[0].conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"gCwFAc6nj7kGQMMbfGM1c1rD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"=Su cita ha sido cancelada, si quiere volver a agendar vuelva a contactarse por este medio, que este muy bien!"},{"name":"private","value":"false"},{"name":"message_type","value":"outgoing"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1632,784],"id":"3ef9a3ac-b6d9-4de0-9fe0-eea75ee82b7b","name":"Enviar mensaje chatwoot1","executeOnce":false},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"iacondiegov@gmail.com","mode":"list","cachedResultName":"iacondiegov@gmail.com"},"limit":20,"timeMin":"={{ $json.startDate }}","timeMax":"={{ $json.endDate }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[992,1072],"id":"78fc115d-bb4f-4b49-bcc7-eb4124e883fa","name":"Get many events1"},{"parameters":{"method":"POST","url":"=https://devchatwoot.iacondiego.es/api/v1/accounts/1/conversations/{{ $('Webhook').item.json.body.conversation.messages[0].conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"gCwFAc6nj7kGQMMbfGM1c1rD"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"=Perfecto lo esperamos maÃ±ana, nos vemosðŸ˜‰"},{"name":"private","value":"false"},{"name":"message_type","value":"outgoing"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1600,1072],"id":"a5ec5a43-3d27-418d-992d-d5a7339af343","name":"Enviar mensaje chatwoot2","executeOnce":false},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"016a0aef-07ec-4825-9667-67878457542b","leftValue":"={{ $json.body.conversation.messages[0].content }}","rightValue":"/No podrÃ© asistir","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"e5956087-0d17-4f44-a2c0-aa5911a931b0","leftValue":"={{ $json.body.conversation.messages[0].content }}","rightValue":"/Si confirmo cita","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[32,448],"id":"2aa4c8ea-3a6c-4061-bc9f-e3dcb591c33c","name":"Confirmacion de citas"},{"parameters":{"assignments":{"assignments":[{"id":"a30bf65d-3d1a-42ef-bfe6-d03e02b86638","name":"chat_input","value":"={{ $json.content }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[928,224],"id":"5f7c1211-d35d-443d-80a8-7bdc8c90b5e3","name":"texto final"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1","mode":"list","cachedResultName":"gpt-4.1"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[2288,512],"id":"fade0755-6b5c-4c2d-9689-4fa6529aaec9","name":"OpenAI Chat Model"},{"parameters":{"operation":"search","base":{"__rl":true,"value":"apprFlWsOgSjwiTHh","mode":"list","cachedResultName":"CRM Agente Reservas","cachedResultUrl":"https://airtable.com/apprFlWsOgSjwiTHh"},"table":{"__rl":true,"value":"tblZii8RTc1BMTRSi","mode":"list","cachedResultName":"Registro clientes","cachedResultUrl":"https://airtable.com/apprFlWsOgSjwiTHh/tblZii8RTc1BMTRSi"},"filterByFormula":"={Telefono}=\"{{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}\"","options":{}},"type":"n8n-nodes-base.airtableTool","typeVersion":2.1,"position":[2640,560],"id":"81cfdd60-860d-4d20-8b9e-21f537c1f7dd","name":"buscar_usuario"},{"parameters":{"operation":"create","base":{"__rl":true,"value":"apprFlWsOgSjwiTHh","mode":"list","cachedResultName":"CRM Agente Reservas","cachedResultUrl":"https://airtable.com/apprFlWsOgSjwiTHh"},"table":{"__rl":true,"value":"tblZii8RTc1BMTRSi","mode":"list","cachedResultName":"Registro clientes","cachedResultUrl":"https://airtable.com/apprFlWsOgSjwiTHh/tblZii8RTc1BMTRSi"},"columns":{"mappingMode":"defineBelow","value":{"Nombre":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Nombre', `Nombre del cliente`, 'string') }}","Telefono":"={{ $('Webhook').item.json.body.conversation.messages[0].sender.phone_number }}"},"matchingColumns":[],"schema":[{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.airtableTool","typeVersion":2.1,"position":[2768,560],"id":"f98041fa-fce2-440d-896a-2fc11960803e","name":"registrar_usuario"},{"parameters":{"jsCode":"const item = $input.first();\nconst inputDate = item.json.formattedDate.trim();   // \"22/04/2025\"\n\n// --- 1. Parsear la fecha DD/MM/YYYY -----------------------------\nconst [day, month, year] = inputDate.split('/').map(Number); // â†’ [22, 4, 2025]\n\n// --- 2. Construir un Date y sumarle 1 dÃ­a -----------------------\nlet base = new Date(year, month - 1, day);          // mes = 0-based\nbase.setDate(base.getDate() + 1);                   // +1 dÃ­a\n\n// --- 3. Helper para devolver ISO sin zona horaria --------------\nconst toISO = (d, hour) => {\n  // Creamos un Date en UTC para la hora pedida\n  const utc = new Date(Date.UTC(\n    d.getFullYear(),\n    d.getMonth(),\n    d.getDate(),\n    hour, 0, 0\n  ));\n  return utc.toISOString().slice(0, 19);            // YYYY-MM-DDTHH:MM:SS\n};\n\n// --- 4. Guardar resultados --------------------------------------\nitem.json.startDate = toISO(base, 8);   // 08:00:00\nitem.json.endDate   = toISO(base, 18);  // 18:00:00\n\nreturn [item];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[800,784],"id":"469b7717-d363-4278-8797-ff7612d7678a","name":"Code"},{"parameters":{"operation":"formatDate","date":"={{ $now }}","format":"custom","customFormat":"dd/MM/yyyy ","options":{}},"type":"n8n-nodes-base.dateTime","typeVersion":2,"position":[624,784],"id":"b09b2cde-6100-485f-af94-d878fe937aef","name":"Date & Time"},{"parameters":{"jsCode":"const item = $input.first();\nconst inputDate = item.json.formattedDate.trim();   // \"22/04/2025\"\n\n// --- 1. Parsear la fecha DD/MM/YYYY -----------------------------\nconst [day, month, year] = inputDate.split('/').map(Number); // â†’ [22, 4, 2025]\n\n// --- 2. Construir un Date y sumarle 1 dÃ­a -----------------------\nlet base = new Date(year, month - 1, day);          // mes = 0-based\nbase.setDate(base.getDate() + 1);                   // +1 dÃ­a\n\n// --- 3. Helper para devolver ISO sin zona horaria --------------\nconst toISO = (d, hour) => {\n  // Creamos un Date en UTC para la hora pedida\n  const utc = new Date(Date.UTC(\n    d.getFullYear(),\n    d.getMonth(),\n    d.getDate(),\n    hour, 0, 0\n  ));\n  return utc.toISOString().slice(0, 19);            // YYYY-MM-DDTHH:MM:SS\n};\n\n// --- 4. Guardar resultados --------------------------------------\nitem.json.startDate = toISO(base, 8);   // 08:00:00\nitem.json.endDate   = toISO(base, 18);  // 18:00:00\n\nreturn [item];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[800,1072],"id":"8c00661f-cd0a-4d64-81d0-a2066c07d053","name":"Code1"},{"parameters":{"operation":"formatDate","date":"={{ $now }}","format":"custom","customFormat":"dd/MM/yyyy ","options":{}},"type":"n8n-nodes-base.dateTime","typeVersion":2,"position":[624,1072],"id":"cc4f5ea4-a7df-44ec-9a51-f687c9bad5f5","name":"Date & Time1"}],"connections":{"AI Agent":{"main":[[{"node":"Enviar mensaje chatwoot","type":"main","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Think":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"conocimiento":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"conocimiento","type":"ai_embedding","index":0}]]},"reservar_cita":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"comprobar_fecha":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"If1":{"main":[[{"node":"If2","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}]]},"If2":{"main":[[],[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"get audio","type":"main","index":0}],[{"node":"get image","type":"main","index":0}],[{"node":"Confirmacion de citas","type":"main","index":0}]]},"get audio":{"main":[[{"node":"OpenAI1","type":"main","index":0}]]},"get image":{"main":[[{"node":"describe image1","type":"main","index":0}]]},"OpenAI1":{"main":[[{"node":"audio content1","type":"main","index":0}]]},"audio content1":{"main":[[{"node":"texto final","type":"main","index":0}]]},"describe image1":{"main":[[{"node":"imagen content1","type":"main","index":0}]]},"imagen content1":{"main":[[{"node":"texto final","type":"main","index":0}]]},"text content1":{"main":[[{"node":"texto final","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Redis","type":"main","index":0}]]},"If":{"main":[[{"node":"Edit Fields","type":"main","index":0}],[{"node":"No Operation, do nothing2","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Redis10","type":"main","index":0}]]},"Redis8":{"main":[[{"node":"Wait","type":"main","index":0}]]},"Redis10":{"main":[[{"node":"If","type":"main","index":0}]]},"Redis":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"modificar_cita":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"enviar_asesor":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"cancelar_cita":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Obtener ID":{"main":[[{"node":"Google Calendar1","type":"main","index":0}]]},"Obtener ID1":{"main":[[{"node":"Delete an event","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"If1","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Date & Time","type":"main","index":0}],[{"node":"Date & Time1","type":"main","index":0}]]},"Get many events":{"main":[[{"node":"Obtener ID1","type":"main","index":0}]]},"Delete an event":{"main":[[{"node":"Enviar mensaje chatwoot1","type":"main","index":0}]]},"Get many events1":{"main":[[{"node":"Obtener ID","type":"main","index":0}]]},"Google Calendar1":{"main":[[{"node":"Enviar mensaje chatwoot2","type":"main","index":0}]]},"Confirmacion de citas":{"main":[[{"node":"Switch1","type":"main","index":0}],[{"node":"text content1","type":"main","index":0}]]},"texto final":{"main":[[{"node":"Redis8","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"buscar_usuario":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"registrar_usuario":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Code":{"main":[[{"node":"Get many events","type":"main","index":0}]]},"Date & Time":{"main":[[{"node":"Code","type":"main","index":0}]]},"Date & Time1":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Get many events1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"devwebhook.iacondiego.es","user-agent":"rest-client/2.1.0 (linux-musl x86_64) ruby/3.3.3p89","content-length":"4481","accept":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3","content-type":"application/json","x-forwarded-for":"172.18.0.1","x-forwarded-host":"devwebhook.iacondiego.es","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"43e56cb911f7","x-real-ip":"172.18.0.1"},"params":{},"query":{},"body":{"account":{"id":1,"name":"IaconDiego"},"additional_attributes":{},"content_attributes":{"in_reply_to_external_id":null,"in_reply_to":null},"content_type":"text","content":"/Si confirmo cita","conversation":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Whatsapp","contact_inbox":{"id":6,"contact_id":3,"inbox_id":3,"source_id":"56954675214","created_at":"2025-07-09T19:50:58.176Z","updated_at":"2025-07-09T19:50:58.176Z","hmac_verified":false,"pubsub_token":"VC6jBWwjnkERp6Fri2JtPzvb"},"id":4,"inbox_id":3,"messages":[{"id":54,"content":"/Si confirmo cita","account_id":1,"inbox_id":3,"conversation_id":4,"message_type":0,"created_at":1752265782,"updated_at":"2025-07-11T20:29:42.340Z","private":false,"status":"sent","source_id":"wamid.HBgLNTY5NTQ2NzUyMTQVAgASGBYzRUIwNDdDNzkyODk1RUUzNDhBMEJCAA==","content_type":"text","content_attributes":{"in_reply_to_external_id":null,"in_reply_to":null},"sender_type":"Contact","sender_id":3,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"/Si confirmo cita","sentiment":{},"conversation":{"assignee_id":1,"unread_count":6,"last_activity_at":1752265782,"contact_inbox":{"source_id":"56954675214"}},"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":3,"identifier":"56954675214@s.whatsapp.net","name":"Diego Vasquez","phone_number":"+56954675214","thumbnail":"https://devchatwoot.iacondiego.es/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBDQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--e529e64b6b9e97520a0658dbbcf95919621ed963/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwQWZvdyIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--2d1e1f21f2d0d56900fab6ec3929f74bcdbbf729/491866785_692113366828012_4827203687698934592_n.jpg","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":3,"identifier":"56954675214@s.whatsapp.net","name":"Diego Vasquez","phone_number":"+56954675214","thumbnail":"https://devchatwoot.iacondiego.es/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBDQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--e529e64b6b9e97520a0658dbbcf95919621ed963/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwQWZvdyIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--2d1e1f21f2d0d56900fab6ec3929f74bcdbbf729/491866785_692113366828012_4827203687698934592_n.jpg","blocked":false,"type":"contact"},"assignee":{"id":1,"name":"Diego Vasquez","available_name":"Diego Vasquez","avatar_url":"","type":"user","availability_status":null,"thumbnail":""},"team":null,"hmac_verified":false},"status":"open","custom_attributes":{},"snoozed_until":null,"unread_count":6,"first_reply_created_at":"2025-07-09T19:51:10.168Z","priority":null,"waiting_since":1752265782,"agent_last_seen_at":1752170861,"contact_last_seen_at":0,"last_activity_at":1752265782,"timestamp":1752265782,"created_at":1752090658,"updated_at":1752265782.45423},"created_at":"2025-07-11T20:29:42.340Z","id":54,"inbox":{"id":3,"name":"Iacondiego API WHATSAPP"},"message_type":"incoming","private":false,"sender":{"account":{"id":1,"name":"IaconDiego"},"additional_attributes":{},"avatar":"https://devchatwoot.iacondiego.es/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBDQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--e529e64b6b9e97520a0658dbbcf95919621ed963/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwQWZvdyIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--2d1e1f21f2d0d56900fab6ec3929f74bcdbbf729/491866785_692113366828012_4827203687698934592_n.jpg","custom_attributes":{},"email":null,"id":3,"identifier":"56954675214@s.whatsapp.net","name":"Diego Vasquez","phone_number":"+56954675214","thumbnail":"https://devchatwoot.iacondiego.es/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBDQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--e529e64b6b9e97520a0658dbbcf95919621ed963/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwQWZvdyIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--2d1e1f21f2d0d56900fab6ec3929f74bcdbbf729/491866785_692113366828012_4827203687698934592_n.jpg","blocked":false},"source_id":"wamid.HBgLNTY5NTQ2NzUyMTQVAgASGBYzRUIwNDdDNzkyODk1RUUzNDhBMEJCAA==","event":"message_created"},"webhookUrl":"https://devwebhook.iacondiego.es/webhook/537662ba-0067-404d-b68a-6436f80309c7","executionMode":"production"}}]},"versionId":"f803fc76-5a9c-4fab-8910-49cab46061f1","triggerCount":0,"tags":[{"createdAt":"2025-11-17T14:36:32.455Z","updatedAt":"2025-11-17T14:36:32.455Z","id":"hrIDh4R5vrcVht8l","name":"hoy"}],"shared":[{"createdAt":"2025-11-20T18:17:54.888Z","updatedAt":"2025-11-20T18:17:54.888Z","role":"workflow:owner","workflowId":"rM9HYRJvNSVOv9uX","projectId":"hjSKGjfHqbYgbRJl","project":{"createdAt":"2025-11-20T16:08:16.301Z","updatedAt":"2025-11-20T17:01:47.741Z","id":"hjSKGjfHqbYgbRJl","name":"Presla Corp <svargas@presla.co>","type":"personal","icon":null,"description":null}}]}