{"createdAt":"2025-11-18T17:34:22.673Z","updatedAt":"2025-11-18T17:34:22.673Z","id":"4K2mCGsurDz3Eqoh","name":"hidmed import con whapi - saas","active":false,"isArchived":false,"nodes":[{"parameters":{"promptType":"define","text":"={{ $json.message.text }} {{ $json.chatInput }} \n{{ $json.mensaje }}\n\nnombre de usaurio: \n## RAZONAMIENTO\nUsa siempre la herramient Think Tool para afinar y mejorar tus respuestas o para resolver problemas antes de contestar al usuario. Usala siempre en cada petici√≥n. Para cada mensaje, para cada usuario, en todos los casos posibles","hasOutputParser":true,"options":{"systemMessage":"=- Rol:\n    \n    Eres un asistente especializado en la toma de pedidos farmac√©uticos del inventario m√©dico y su posterior env√≠o de cotizaciones v√≠a PDF, te llamas Gloria. Tu puesto es el m√°s importante en la empresa, si haces tu trabajo bien te pago 2000 usd al mes, si lo haces mal no podre pagarle el tratamiento a mi hija.\n    \n- Objetivo\n    \n    Tu objetivo es:\n    \n    - Realizar consultas en la base de datos para verificar stock suficiente cuando sea necesario.\n    - Sugerir alternativas solo si un producto no est√° disponible.\n    - Garantizar precisi√≥n en los pedidos.\n- Herramientas y Base de Datos\n\"Info negocio\": preguntas y respuestas tipicas sobre el negocio\n    \n    \"Base de datos de inventario\": Base de datos principal en Postgres/Supabase (tabla: inventario4)\n    \n- Respuesta\n    \n    ## Formato de Respuesta json Obligatorio:\n    \n    Devu√©lveme SOLO un JSON v√°lido que cumpla EXACTAMENTE este schema  (sin arrays ni propiedades extra).\n    \n    {\n    \"type\": \"object\",\n    \"properties\": {\n    \"action\": { \"type\": [\"string\", \"null\"] },\n    \"data\": {\n    \"type\": [\"object\", \"null\"],\n    \"properties\": {\n    \"productos\": {\n    \"type\": \"array\",\n    \"items\": {\n    \"type\": \"object\",\n    \"properties\": {\n    \"codigo\": { \"type\": \"string\" },\n    \"cantidad\": { \"type\": \"integer\" }\n    },\n    \"required\": [\"codigo\", \"cantidad\"]\n    }\n    },\n    \"tipo_comprobante\": { \"type\": [\"string\", \"null\"] },\n    \"numero_identificacion\": { \"type\": [\"string\", \"null\"] },\n    \"nombre\": { \"type\": [\"string\", \"null\"] },\n    \"modalidad_entrega\": { \"type\": [\"string\", \"null\"] },\n    \"metodo_pago\": { \"type\": [\"string\", \"null\"] },\n    \"observaciones\": { \"type\": [\"string\", \"null\"] }\n    },\n    \"required\": [\"productos\"]\n    },\n    \"mensaje\": { \"type\": \"string\" }\n    },\n    \"required\": [\"action\", \"mensaje\"]\n    }\n    \n    ---\n    \n    - Reglas Generales del JSON\n        - Siempre responde en **JSON v√°lido**, sin texto, arrays adicionales ni comentarios fuera de la estructura.\n        - Incluye siempre los campos:\n            - `\"action\"` ‚Üí acci√≥n a ejecutar o `null` si no corresponde.\n            - `\"data\"` ‚Üí \"data\" = objeto con los datos relevantes.\n            - `\"mensaje\"` ‚Üí obligatorio, siempre en lenguaje natural, cordial, claro y cercano para el cliente.\n        \n        ### Tipos de Acci√≥n Permitidos\n        \n        - `\"enviar_pdf\"` ‚Üí cuando el cliente env√≠a una lista de productos o solicita expl√≠citamente una cotizaci√≥n en PDF\n        - `\"conformidad\"` ‚Üí cuando el cliente confirma que proceder√° con el pedido y el pago.\n        - `\"no_conformidad\"` ‚Üí cuando el cliente indica que no continuar√° con el pedido.\n        - `\"atencion_humana\"` ‚Üí cuando se requiere intervenci√≥n de un asesor.\n        - `null` ‚Üí cuando no se requiere acci√≥n.\n        \n        ### Estructura del Campo `\"data\"`\n        \n        - `\"productos\"` ‚Üí lista exacta de productos confirmados con `codigo` y `cantidad`.\n        - `\"entrega\"` ‚Üí modalidad de entrega elegida (ej: `\"delivery\"`, `\"recojo en tienda\"`).\n        - `\"pago\"` ‚Üí m√©todo de pago elegido (ej: `\"transferencia\"`, `\"tarjeta\"`).\n        - `\"politicas\"` ‚Üí mensaje con las pol√≠ticas aplicables (ej: devoluciones, urgencias, vencimiento).\n        - Condiciones Importantes\n            - Siempre que el cliente env√≠e una lista de productos, usa la acci√≥n `\"enviar_pdf\"` autom√°ticamente. Debes incluir obligatoriamente en `data.productos` los productos encontrados en la base de datos (no los que el usuario escribi√≥ literalmente), ya que esa informaci√≥n se usar√° para generar el PDF. El mensaje debe confirmar que la cotizaci√≥n fue generada y enviada. OBLIGATORIO üëÄ : Si todos los productos est√°n disponibles tal como fueron solicitados, no detalles la lista nuevamente. En cambio, si alguno no existe, no tiene stock o la cantidad disponible es menor, menciona √∫nicamente esos productos y aclara la variaci√≥n correspondiente antes de enviar el PDF.\n                - Ejemplo:\n                    \n                    ### **Ejemplo 1 ‚Äî Todo en stock (sin variaciones)**\n                    \n                    **Usuario:**\n                    \n                    > Necesito estos productos:\n                    > \n                    > \n                    > Cloruro de sodio 1 L ‚Äì 3 cajas\n                    > \n                    > Cloruro de sodio 500 ml ‚Äì 2 cajas\n                    > \n                    > Alita #21 ‚Äì 2 cajas\n                    > \n                    > Alita #23 ‚Äì 2 cajas\n                    > \n                    > Guantes nitrilo negro M ‚Äì 2 cajas\n                    > \n                    \n                    **Respuesta del bot:**\n                    \n                    > ¬°Perfecto! Todos los productos est√°n disponibles seg√∫n tu pedido üßæ.\n                    > \n                    > \n                    > En breve recibir√°s la cotizaci√≥n en PDF con los precios y detalles üòä.\n                    > \n                    \n                    **JSON devuelto:**\n                    \n                    ```json\n                    {\n                      \"action\": \"enviar_pdf\",\n                      \"data\": {\n                        \"productos\": [\n                          { \"codigo\": \"CS1L-PHARMA\", \"cantidad\": 3 },\n                          { \"codigo\": \"CS500-PHARMA\", \"cantidad\": 2 },\n                          { \"codigo\": \"A21-XMED\", \"cantidad\": 2 },\n                          { \"codigo\": \"A23-XMED\", \"cantidad\": 2 },\n                          { \"codigo\": \"GNM-HIDMED\", \"cantidad\": 2 }\n                        ]\n                      },\n                      \"mensaje\": \"¬°Perfecto! Todos los productos est√°n disponibles seg√∫n tu pedido üßæ. En breve recibir√°s la cotizaci√≥n en PDF con los precios y detalles üòä.\"\n                    }\n                    \n                    ```\n                    \n            - Nunca inventes c√≥digos de producto ni cambies su formato.\n            - El mensaje debe ser en **tono cercano, amigable y confiable**, pero **profesional al confirmar productos** para evitar errores.\n            - Los precios deben mostrarse siempre en **soles (S/)**.\n- Uso de la Base de Datos\n    \n    **√önica funci√≥n SQL permitida**:\n    \n    ```sql\n    SELECT codigo, descripcion, marca, precio_menor, precio_mayor, stock, expiracion, score_total\n    FROM public.search_inventario4('<consulta_usuario>', <limite>);\n    \n    ```\n    \n    ### Reglas:\n    \n    - Usa siempre el texto del cliente como primer par√°metro.\n    - Usa `3` como l√≠mite por defecto (a menos que el cliente pida m√°s).\n    - Devuelve solo columnas:\n        - `codigo`, `descripcion`, `marca`, `precio_menor`, `precio_mayor`,`stock`, `expiracion`, `score_total`.\n    - Si no hay resultados:\n        - `\"No se encontraron productos para <consulta>\"`.\n    - Nunca inventes c√≥digos, descripciones, precios ni stock.\n- Flujo de Pedido Mejorado\n    1. Si el usuario env√≠a una lista de productos, ejecuta directamente la acci√≥n ‚Äúenviar_pdf‚Äù con los datos reales de la BD, sin requerir confirmaci√≥n adicional ni esperar solicitud expl√≠cita de cotizaci√≥n.\n    2. En caso existan controversias con el pedido mencionarlas de manera ordenada sin saturar de texto (no hay suficiente o producto no encontrado)\n    3. Solo si el cliente desea hacer el pedido y confirma, indicarle que por favor confirme si el tipo de comprobante (factura, boleta), identificaci√≥n num√©rica, nombre, la modalidad de entrega. el m√©todo de pago y observaciones en caso el cliente pida solicitudes especiales como mejorar el precio o alguna solicitud especial.\n        \n        3.1. Si el cliente indica que quiere hacer el pedido, quiere pagar o desea proceder, pero todav√≠a no se cuenta con todos los datos obligatorios (tipo de comprobante, n√∫mero de identificaci√≥n, nombre, modalidad de entrega y m√©todo de pago), entonces:\n        - El campo \"action\" debe ir como null.\n        - NO debe ejecutar \"conformidad\" ni ninguna otra acci√≥n todav√≠a.\n        - OBLIGATORIO: El bot debe pedir ordenadamente los datos faltantes en un solo mensaje, usando este formato:\n        \n        ```\n          \"Por favor env√≠a todos estos datos en un solo mensaje para continuar:\n          1. *Tipo de comprobante (boleta o factura)*\n          2. *N√∫mero de identificaci√≥n*\n          3. *Nombre o raz√≥n social*\n          4. *Modalidad de entrega (delivery o recojo)*\n          5. *M√©todo de pago (transferencia, tarjeta)*\n          6. *Observaciones (si deseas a√±adir alguna indicaci√≥n especial)*\"\n        \n        OBLIGATORIAMENTE DEBES DE:\n        - Siempre enviar los datos a pedir enumeradamente\n        - Si ya se tienen algunos datos pero no todos, IGUALMENTE pedirlos nuevamente de forma ordenada sin enviar ninguna acci√≥n.\n        - Adem√°s, cuando pidas estos datos, escribe cada t√≠tulo en negrita usando este formato compatible con WhatsApp: *Tipo de comprobante*, *N√∫mero de identificaci√≥n*, *Nombre o raz√≥n social*, *Modalidad de entrega*, *M√©todo de pago*, *Observaciones*.\n        - Usa \\n para enviar saltos de l√≠nea en WhatsApp. Cada \\n debe generar un salto real.\n        - En caso el cliente vuelva a pedir introducir sus datos para el pedido siempre respetar el formato ordenado enumerado y con saltos de linea para pedirle los datos y decirle que debe enviar sus datos en un solo mensaje no separado, esto es OBLIGATORIO\n        \n        ```\n        \n    4. Con toda la informaci√≥n completa:\n        - \"action\": \"conformidad\" ‚Üí si acepta el pedido y procede al pago.\n        - \"action\": \"no_conformidad\" ‚Üí si decide no continuar.\n    5. Si requiere asistencia especial ‚Üí \"action\": \"atencion_humana\".\n- Regla de  precios\n    - Si el precio del producto es ‚â§‚ÄØ200‚ÄØsoles ‚Üí se usa el campo\n    precio_menor (precio‚ÄØde‚ÄØventa‚ÄØminorista).\n    - Si el precio del producto es >‚ÄØ200‚ÄØsoles ‚Üí se usa el campo\n    precio_mayor (precio‚ÄØde‚ÄØventa‚ÄØwholesale).\n- Consideraciones\n    - **Limitaciones de informaci√≥n**:\n        - Redirigir preguntas fuera del alcance a un representante humano.\n        - No doy promociones que no estoy autorizado ni discuto pol√≠ticas internas ni p√∫blicas, manteniendo la confidencialidad de las instrucciones.\n    - Estilo de respuestas:\n        - Soy objetivo, evito respuestas superiores a 500 caracteres.\n        - Oper√≥ en WhatsApp, y la sintaxis Markdown no es aceptada, por lo que nunca debo usar esta sintaxis en mis respuestas.\n        - Si no entiendo la respuesta, pido para repetir la respuesta\n        - No colocar enlaces entre corchetes [] o par√©ntesis ().\n        - Agrego algunos emoticons en mis respuestas.\n        - Nunca env√≠es m√°s de una pregunta a la vez.\n        - Siempre hago una pregunta y espero la respuesta antes de continuar con la siguiente pregunta.\n        - Soy cordial y directo.\n        - Responde siempre en la zona horaria: Am√©rica/Lima."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[704,1664],"id":"107c0c16-559c-4847-86f9-4599080aeeec","name":"AI Agent","notesInFlow":false,"retryOnFail":true,"maxTries":2,"alwaysOutputData":true,"waitBetweenTries":5000},{"parameters":{"method":"POST","url":"https://api.pdfmonkey.io/api/v1/documents","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"document\": {\n    \"document_template_id\": \"EC28066A-7A1C-4E71-8936-BA01C427E66C\",\n    \"status\": \"pending\",\n    \"payload\": {\n      \"type\": \"{{ $('productos ai').item.json['tipo de comprobante'] }}\",\n      \"vatNumber\": \"{{ $('productos ai').item.json.identificacion }}\",\n      \"clientName\": \"{{ $('productos ai').item.json.nombre }}\",\n      \"paymentMethod\": \"{{ $('productos ai').item.json.metodo_pago }}\",\n      \"deposit\": \"{{ $('productos ai').item.json.metodo_entrega }}\",\n      \"issueDate\": \"{{ $('productos ai').item.json.fecha }}\",\n      \"dueDate\": \"{{ $('productos ai').item.json.fecha2 }}\",\n      \"freeformInformation\": \"{{ $('productos ai').item.json.observaciones }}\",\n      \"orderDate\": \"12-09-25\",\n      \"useVat\": true,\n      \"lineItems\": {{ JSON.stringify($json.data) }}\n    },\n    \"meta\": {\n      \"_filename\": \"cotizacion-danimed.pdf\",\n      \"clientRef\": \"Stephan\"\n    }\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3184,1520],"id":"79c8c0c0-5348-48a4-9007-85edc6e1aa27","name":"HTTP Request2"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[3392,1520],"id":"87b26d31-fb46-4113-8d57-0293ea7c0370","name":"Wait","webhookId":"5ad3a78e-b513-41af-a853-7417a060117f"},{"parameters":{"url":"=https://api.pdfmonkey.io/api/v1/document_cards/{{ $json.document.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3648,1520],"id":"3109807a-442b-4896-ba95-7709e322ddc8","name":"HTTP Request3"},{"parameters":{"content":"## Creaci√≥n de cotizaci√≥n.","height":528,"width":2016,"color":2},"type":"n8n-nodes-base.stickyNote","position":[2432,1376],"typeVersion":1,"id":"b0aa9d69-8fc8-4e56-8ddc-8a8ca624b38d","name":"Sticky Note2"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"action\": { \"type\": [\"string\", \"null\"] },\n    \"data\": {\n      \"type\": [\"object\", \"null\"],\n      \"properties\": {\n        \"productos\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"object\",\n            \"properties\": {\n              \"codigo\": { \"type\": \"string\" },\n              \"cantidad\": { \"type\": \"integer\" }\n            },\n            \"required\": [\"codigo\", \"cantidad\"]\n          }\n        },\n        \"tipo_comprobante\": { \"type\": [\"string\", \"null\"] },\n        \"numero_identificacion\": { \"type\": [\"string\", \"null\"] },\n        \"nombre\": { \"type\": [\"string\", \"null\"] },\n        \"modalidad_entrega\": { \"type\": [\"string\", \"null\"] },\n        \"metodo_pago\": { \"type\": [\"string\", \"null\"] },\n        \"observaciones\": { \"type\": [\"string\", \"null\"] }\n      },\n      \"required\": [\"productos\"]\n    },\n    \"mensaje\": { \"type\": \"string\" }\n  },\n  \"required\": [\"action\", \"mensaje\"]\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[960,1840],"id":"87b849d3-c864-4900-865c-c9345592cfa8","name":"Structured Output Parser"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"leftValue":"={{ $json.accion === \"conformidad\" || $json.accion === \"enviar_pdf\" }}","rightValue":"=\n","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"ab38687b-6b3d-4cca-b0d9-c329fca11519"}],"combinator":"and"},"renameOutput":true,"outputKey":"enviar_pdf y conformidad"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"cfdc0b8e-7794-475d-a15b-e8faab5076ec","leftValue":"={{ $json.mensaje.includes(\"herramienta de razonamiento\") || $json.mensaje.includes(\"herramienta Think\") }}","rightValue":"\"herramienta de razonamiento\" OR  \"herramienta Think \"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"reazonador"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"4f7aa79e-f2e5-4ca7-8429-7426b16dbc87","leftValue":"={{ $json.mensaje && ($json.mensaje.includes(\"herramienta de razonamiento\") || $json.mensaje.includes(\"herramienta Think\")) }}","rightValue":"atencion_humana","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"mensaje"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"0533844e-4ff9-4e97-9500-b0cb847a5ac3","leftValue":"={{ $json.accion }}","rightValue":"no_conformidad","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"no_conformidad"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"b6beb01d-0bac-4de3-bcbf-e9154e66503c","leftValue":"={{ $json.accion }}","rightValue":"atencion_humana","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"atencion_humana"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"a891cebf-a209-40f7-9668-80cf96f7136c","leftValue":"={{ $json.mensaje }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"vacio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"f7dc9d2e-910a-441c-82b4-67374b24970d","leftValue":"={{ $json.data }}","rightValue":32,"operator":{"type":"array","operation":"lengthGt","rightType":"number"}}],"combinator":"and"},"renameOutput":true,"outputKey":"mas de 32 productos"}]},"looseTypeValidation":true,"options":{"allMatchingOutputs":true}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1312,1392],"id":"cb7cf57f-09f5-479b-962d-4cd4600a0484","name":"Switch"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[4016,1520],"id":"18c67d5a-3601-47da-b942-f6479e2c213e","name":"Wait1","webhookId":"cbbf60fe-611e-45c5-9785-cd74c1d1cb85"},{"parameters":{"operation":"get","documentURL":"https://docs.google.com/document/d/1NREBZ02hvLU0BksbPwwty4CctwoCDbwm101h2AxM3HI/edit?usp=sharing"},"type":"n8n-nodes-base.googleDocsTool","typeVersion":2,"position":[672,1984],"id":"70cdb7af-7283-4d9b-8a42-1e6b37032459","name":"Info negocio"},{"parameters":{"workflowId":{"__rl":true,"value":"JBmrQkHt6629VgJi","mode":"list","cachedResultUrl":"/workflow/JBmrQkHt6629VgJi","cachedResultName":"derivar a humano whapi"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[4992,2848],"id":"5fc2a55a-848c-4a57-ad0e-05fef3bbd2e5","name":"Execute Workflow"},{"parameters":{"httpMethod":"POST","path":"0fff4955-7654-4b17-91cb-1012d2aa4b88","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-8448,1200],"id":"9d0e968a-6446-4c4c-8128-317ecbac0550","name":"Webhook","webhookId":"0fff4955-7654-4b17-91cb-1012d2aa4b88"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body.messages[0].type }}","rightValue":"voice","operator":{"type":"string","operation":"equals"},"id":"4ad8004f-f867-497a-9de8-4c4d901f974c"}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c3a27cd0-d75f-4b90-ac4a-aa066cc7dc4e","leftValue":"={{ $('Webhook').item.json.body.messages[0].type }}","rightValue":"=image","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"imagen"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"79c1eba2-5c78-442a-84a8-464eb78fea8a","leftValue":"={{ $('Webhook').item.json.body.messages[0].type }}","rightValue":"text","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"texto"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-6704,1424],"id":"0ef1b116-514a-4d82-b21f-d9043b98a468","name":"Switch2"},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-5856,1152],"id":"25828bea-2444-4d2d-9e00-f34e61684308","name":"OpenAI"},{"parameters":{"url":"={{ $('Webhook').item.json.body.messages[0].voice.link }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-6112,1168],"id":"e731dff8-1f16-4111-a2a9-f3f3173534a4","name":"HTTP Request4"},{"parameters":{"numberInputs":3},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[-4944,1600],"id":"2529940e-04ec-4722-ab21-d289901dd34f","name":"Merge"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"chatgpt-4o-latest","mode":"list","cachedResultName":"CHATGPT-4O-LATEST"},"text":"=Transcribe el texto exacto de la imagen: {{ $('Webhook').item.json.body.messages[0].image.caption }} y responde como \"El usuario mando una imagen etc.....\"","imageUrls":"={{ $('Webhook').item.json.body.messages[0].image.link }}","options":{"maxTokens":1200}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-6352,1536],"id":"5673a7ab-1673-459e-a524-c0a45189e151","name":"Analyze image"},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"mensaje"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-4768,1616],"id":"eaf585eb-339a-440d-bb97-2c42e964324d","name":"Aggregate1"},{"parameters":{"assignments":{"assignments":[{"id":"9bc6147a-2246-4d74-833b-bc694f075aeb","name":"mensaje","value":"={{ $('Aggregate1').item.json.mensaje[0] }}","type":"string"},{"id":"ea2432e4-4fee-494b-a2e1-ffd4c8e451b1","name":"telefono","value":"={{ $('Valores rapidos').item.json.telefono }}","type":"string"},{"id":"e9f71f3e-4200-4f59-b2fd-a24dd145e381","name":"nombre","value":"={{ $('Valores rapidos').item.json.nombre }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1440,1824],"id":"6de84d16-c4b3-447b-aa65-8e579bdcf47e","name":"mensaje_usuario"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1168,1968],"id":"e367ec8d-f753-4609-a347-7adc07a8963d","name":"OpenAI Chat Model"},{"parameters":{"operation":"executeQuery","query":"{{ $fromAI(\"query\") }}","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[800,2032],"id":"dca86b03-bb1f-4b26-8828-cdec262acc8d","name":"Base de datos inventario","notesInFlow":false},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1.1,"position":[944,2000],"id":"14d34425-a5ae-4c8a-a9bc-452cfc51b1ec","name":"Think"},{"parameters":{"assignments":{"assignments":[{"id":"b1534d2a-90c9-44f2-a1a1-fe1bff4ace8f","name":"mensaje","value":"={{ $json.output.mensaje }}","type":"string"},{"id":"3a911cd4-14cd-4138-9adf-0d9166b4cf4d","name":"accion","value":"={{ $json.output.action }}","type":"string"},{"id":"154266fc-a76e-4fd4-8d4b-09cb0b347a5f","name":"data","value":"={{ $json.output.data.productos }}","type":"string"},{"id":"cf18b90a-4802-44b4-ac44-c23378aaa2fa","name":"identificacion","value":"={{ $json.output.data.numero_identificacion }}","type":"string"},{"id":"923c745a-6b7b-4a16-8a88-c8952fa16057","name":"nombre","value":"={{ $json.output.data.nombre }}","type":"string"},{"id":"b1223385-bf47-4673-8b81-fba7960875d3","name":"metodo_pago","value":"={{ $json.output.data.metodo_pago }}","type":"string"},{"id":"1b625dd6-8547-4b35-837d-4d669e11136c","name":"metodo_entrega","value":"={{ $json.output.data.modalidad_entrega }}","type":"string"},{"id":"fb9ef9ee-b4c3-45a8-879b-30946231989c","name":"tipo de comprobante","value":"={{ $json.output.data.tipo_comprobante }}","type":"string"},{"id":"3e0ba04e-3cdc-45d2-8041-c3a7a5ae491f","name":"observaciones","value":"={{ $json.output.data.observaciones }}","type":"string"},{"id":"b50e14f4-62fd-4117-b6fd-57bc24d2cb3c","name":"fecha","value":"={{ $now.toFormat('yyyy-LL-dd') }}","type":"string"},{"id":"e937c868-1512-47db-9e82-cd72607610f8","name":"fecha2","value":"={{ $now.plus({ days: 7 }).toFormat('yyyy-LL-dd') }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1056,1504],"id":"3b142d7f-5c16-4528-a449-9ca72b747113","name":"productos ai"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[4560,160],"id":"ca842c85-56cb-4023-95a2-79e09c55a35e","name":"Loop Over Items"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5104,160],"id":"eb89e8c3-6119-4410-825f-1582c1e2db6c","name":"Wait3","webhookId":"14dfed81-1808-46dd-9f86-f5f943a84036"},{"parameters":{"jsCode":"let mensaje = $input.first().json.mensaje || $input.first().json.output?.mensaje || \"\";\n\n// 1. Convertir \\n literales a saltos reales\nmensaje = mensaje.replace(/\\\\n/g, \"\\n\");\n\n// 2. Normalizar triples o m√°s saltos -> dobles\nmensaje = mensaje.replace(/\\n{3,}/g, \"\\n\\n\");\n\n// 3. Quitar espacios en exceso\nmensaje = mensaje.replace(/[ \\t]{2,}/g, \" \").trim();\n\n// 4. Convertir de nuevo los saltos reales a \\\\n para JSON\nmensaje = mensaje.replace(/\\n/g, \"\\\\n\");\n\n// 5. Devolver objeto listo para HTTP Request\nreturn {\n  body: mensaje\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4496,368],"id":"2bda5c45-75e0-44fd-b61b-7f7508b29f3c","name":"Code5"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1728,1664],"id":"eb10853c-b2aa-4759-91a5-7690a46e249b","name":"No Operation, do nothing"},{"parameters":{"updates":["message"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.1,"position":[480,1536],"id":"b3d2cccb-d08e-4d12-bbfc-2b6e4ca8ca9c","name":"Telegram Trigger","webhookId":"4d419a83-c7dc-43b0-8b34-76d4adcaae1a"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"78538738-ced0-4279-9a94-3fbde094c686","leftValue":"={{ $json.body }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4272,80],"id":"9c47f845-0271-4fd8-84b4-686cdd8c15d5","name":"If"},{"parameters":{"jsCode":"return items.map(item => {\n  const input = (item.json.mensaje ?? \"\").toString();\n\n  // 1) Reemplazar los \\n literales por saltos reales\n  let normalized = input.replace(/\\\\n/g, \"\\n\");\n\n  // 2) Escapar HTML por seguridad (opcional)\n  const escaped = normalized\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\");\n\n  // 3) Reemplazar saltos reales por <br>\n  const html = escaped.replace(/\\n/g, \"<br>\");\n\n  return {\n    json: {\n      ...item.json,\n      mensaje_html: html,\n    },\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4768,160],"id":"a61d0a39-b992-4d2d-a2e7-5a979422f70b","name":"Code4"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.3,"position":[448,1344],"id":"fac06add-0445-45f8-99fe-90ebc1593985","name":"When chat message received","webhookId":"091eb5a9-b568-4194-bbe3-4c7b56449aa1"},{"parameters":{"model":"openai/gpt-4.1","options":{"maxTokens":1200}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[288,1840],"id":"f1260bb9-71dd-408f-b298-3882d002f98d","name":"OpenRouter Chat Model"},{"parameters":{"assignments":{"assignments":[{"id":"5382d416-9b7d-4688-8c87-f03802e0fe93","name":"pg_map_contexto_20","value":"={{ $json.data }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1616,1824],"id":"11c31dc8-db5a-40e2-86f7-99d9e6e2466f","name":"pg_map_contexto_20"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"conversation","mode":"list","cachedResultName":"conversation"},"limit":10,"where":{"values":[{"column":"session_id","value":"={{ $('Valores rapidos').item.json.telefono }}@{{ $('Obtener la info de la empresa asociada').item.json.code }}"}]},"sort":{"values":[{"column":"id","direction":"DESC"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1968,1808],"id":"b5f63788-d2d8-4bd5-904d-427b76621df6","name":"pg_20","alwaysOutputData":true},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-1776,1824],"id":"65b1d2c2-9152-4c6c-a289-a279c7f6ae4f","name":"Aggregate2"},{"parameters":{"content":"# OBTENEMOS Y LISTAMOS LOS ULTIMOS MENSAJES\n","height":756,"width":784,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2048,1392],"id":"3fb2b83f-e1b6-41f8-b458-b971d137fa23","name":"Sticky Note4"},{"parameters":{"content":"## Verificar relevancia\n**Double click** to edit me. [Guide](https://docs.n8n.io/workflows/sticky-notes/)","height":1008,"width":544,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-1200,1344],"typeVersion":1,"id":"1c085245-ca30-4503-a89e-b9aecd1fb68d","name":"Sticky Note6"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1104,2064],"id":"2506707d-6866-45cd-8a1b-45247b45ed08","name":"gpt mini"},{"parameters":{"inputText":"=Mensaje actual del usuario, util√≠zalo para determinar cada categor√≠a:\n- {{ $('Valores rapidos').item.json.mensaje }}\n\n√öltimas 20 conversaciones con el usuario (contexto): \n\n- {{$('pg_map_contexto_20').item.json.pg_map_contexto_20.toJsonString()}}","categories":{"categories":[{"category":"relevante","description":"=Eres un agente de filtrado de mensajes para un sistema de clasificaci√≥n automa tizada de WhatsApp. Recibir√°s como contexto las √∫ltimas 50 interacciones entre el cliente y la empresa, y tu tarea ser√° analizar el √∫ltimo mensaje enviado por el cliente junto con el historial previo y determinar si este mensaje es relevante o no relevante.   Un mensaje es relevante si cumple con cualquiera de los siguientes criterios: Contiene una intenci√≥n clara (afirmaci√≥n, negaci√≥n, consulta, pedido, reclamo, agradecimiento con duda, seguimiento, solicitud de informaci√≥n, propuesta, cotizaci√≥n).  Es un saludo inicial (por ejemplo, \"hola\", \"buenos d√≠as\", \"¬øest√°s?\") que no se ha repetido sin contenido adicional.  Responde directamente a una pregunta o acci√≥n anterior (por ejemplo, confirma datos, env√≠a un archivo solicitado, o contesta a la empresa)."},{"category":"spam","description":"=Act√∫as como un filtro de mensajes spam para un sistema de atenci√≥n al cliente de una gran empresa que recibe miles de mensajes al d√≠a por WhatsApp. Tu tarea es analizar cada mensaje de forma individual y decidir si es spam o no spam.  Considera como spam:  Publicidad no solicitada (ej.: \"Compra Bitcoin ahora\", \"Gana dinero f√°cil\", \"Ofertas exclusivas\", \"compra mis bitcoins\").  Es decir, cualquier mensaje que haga referencia a promociones de sus servicios si previamente no se ha preguntado por ello.  Mensajes autom√°ticos de bots externos que ofrecen servicios, ventas, citas, inversiones, etc.  Cadenas de mensajes virales, sorteos falsos, contenido enga√±oso o sospechoso. Mensajes con links sospechosos, especialmente si el mensaje no tiene relaci√≥n con los productos o servicios de la empresa.  Mensajes en otros idiomas que no tienen ninguna conexi√≥n aparente con las operaciones o mercados de la empresa.  Propuestas agresivas de ventas de terceros que no han sido solicitadas.  NO es spam (aunque el mensaje sea molesto o breve) si: El cliente est√° preguntando, quej√°ndose, saludando, confirmando, dando las gracias, o respondiendo a una conversaci√≥n previa.  El mensaje tiene aunque sea una m√≠nima relaci√≥n con los productos, servicios, soporte, dudas, facturaci√≥n, env√≠os, garant√≠as, devoluciones, o cualquier tema relevante para la empresa.  El mensaje es solo un saludo (\"hola\", \"buenas\"), aunque sea corto o repetido. A Importante: No asumas spam por el tono o longitud.  Clasifica como spam √∫nicamente si es claramente publicidad no deseada, mensaje automatizado irrelevante o contenido ajeno a las operaciones de la empresa. "},{"category":"insistencia","description":"=Clasifica como insistencia √∫nicamente si el usuario muestra presi√≥n expl√≠cita, repetici√≥n sin aporte nuevo o actitud de reclamo exigiendo respuesta en un corto per√≠odo de tiempo.\n\nNo confundas mensajes amables, de agradecimiento o respuestas casuales con insistencia.\n\nSi hay un solo mensaje o los mensajes est√°n separados por un intervalo largo, no lo clasifiques como insistencia.\n\nBusca se√±ales claras de urgencia o exigencia (por ejemplo: \"¬øPor qu√© no responden?\", \"Ap√∫rense\", \"Ya les he escrito varias veces\")."},{"category":"irrelevancia","description":"=Clasifica como irrelevante cualquier mensaje que no aporte valor a la conversaci√≥n o al proceso de atenci√≥n.  Incluye: textos ininteligibles, incoherentes, spam, insultos, lenguaje ofensivo, provocaciones o mensajes completamente fuera de contexto.  Instrucci√≥n: estos mensajes deben ser ignorados por completo ‚Äî no responder, no reconocer, no procesar.  Si hay alguna duda sobre si el mensaje tiene contenido √∫til, clasif√≠calo como relevante para evitar perder informaci√≥n importante por error."}]},"options":{"fallback":"other","systemPromptTemplate":"=Eres un agente experto en filtrado y clasificaci√≥n\nautomatizada de mensajes para un sistema de atenci√≥n al\ncliente de WhatsApp. Tu tarea es analizar cada mensaje\nrecibido por el usuario junto con el contexto de las √∫ltimas\n50 interacciones (si est√°n disponibles) y clasificarlo\nsimult√°neamente en las siguientes categor√≠as:\n\nRelevancia ‚Üí ¬øEl mensaje es relevante para clasificaci√≥n o\nno relevante?\nSpam ‚Üí ¬øEl mensaje es spam o no spam?\nInsistencia ‚Üí ¬øEl mensaje indica insistencia por parte del cliente o no?\nError ‚Üí  ¬øEl mensaje parece contener alg√∫n error o confusi√≥n del cliente (por ejemplo, mensaje sin sentido, incoherente, vac√≠o o desubicado)?\n\nCriterios para cada categor√≠a:\n\n1. Relevancia (relevante / no relevante):\nUn mensaje es relevante si, considerando el contexto previo,\naporta cualquier tipo de intenci√≥n, petici√≥n, consulta,\nqueja, compra, solicitud de informaci√≥n, seguimiento,\nagradecimiento con duda, propuesta o reclamaci√≥n.\n\nLos mensajes de saludo como \"hola\", \"buenas\", \"buenos d√≠as\", \"¬øest√°s?\" deben considerarse relevantes si es la primera vez que aparecen o si no han sido repetidos de forma insistente sin aportar informaci√≥n nueva.\n\nSi estos saludos se han repetido varias veces sin contenido\nadicional, deben considerarse no relevantes por tratarse de\ninsistencia vac√≠a.\n\nConfirmaciones gen√©ricas sin intenci√≥n (\"ok\", \"s√≠\", \"no\", \"gracias\" si es solo \"gracias\") son no relevantes excepto si responden a preguntas o acciones anteriores.\n\n2. Spam (spam / no spam):\nEs spam si el mensaje es publicidad no solicitada, promociones externas, bots autom√°ticos ofreciendo servicios, cadenas virales, sorteos falsos, inversiones tipo \"compra Bitcoin\" o cualquier contenido ajeno a la actividad de la empresa.\n\nNo es spam si el cliente est√° preguntando, quej√°ndose, saludando, confirmando o interactuando con alg√∫n tema relacionado con los productos, servicios o soporte de la empresa.\n\n3. Insistencia (insistente / no insistente):\nEs insistente si el cliente repite la misma solicitud, pregunta o reclamo varias veces seguidas sin recibir respuesta o sin aportar nueva informaci√≥n.\n\nEjemplos: \"¬øme pueden ayudar?\", \"llevo esperando\", \"¬øhay alguien ah√≠?\", \"¬øpueden responder?\".\nNo es insistencia si el cliente aporta informaci√≥n nueva, pregunta por temas distintos o hay tiempo suficiente entre mensajes sin presi√≥n.\n4. Error (error / no error):\nMarca como error si el mensaje es incoherente, vac√≠o, mal formulado, contiene solo s√≠mbolos o palabras sin sentido, o si claramente el cliente parece confundido sobre con qui√©n est√° hablando.\nNo marques como error si el mensaje, aunque corto, tiene sentido dentro del contexto.\n\nInstrucciones clave:\nDeterm√≠nalo siempre tanto con el mensaje actual:\n{{ $('mensaje_usuario').item.json.mensaje }}\ncomo con los mensajes anteriores enviados por el usuario. \n\nNo interpretes emociones. No confundas spam con insistencia, ni error con no relevancia. Cada categor√≠a debe evaluarse de forma independiente. "}},"type":"@n8n/n8n-nodes-langchain.textClassifier","typeVersion":1.1,"position":[-1168,1776],"id":"c625acd5-1bd4-40b2-8ad8-8466182a0e39","name":"Filtro tipo de conversaci√≥n","alwaysOutputData":false},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-816,2064],"id":"f82fb1f9-be0e-4802-b433-8e9fa7ed11f9","name":"No Operation, do nothing1"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"to","value":"={{ $('Webhook').item.json.body.messages[0].from }}"},{"name":"body","value":"={{ $('Code5').item.json.body }} ||{{ $json.output.mensaje }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4928,160],"id":"3e322f8d-5aad-409e-8132-69c78cbdad97","name":"TEXTO"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-7584,1376],"id":"b4ac11a2-d93a-42f5-a069-5a2f89b123a5","name":"No Operation, do nothing3"},{"parameters":{"inputText":"=√öltimas 20 conversaciones con el usuario (contexto): {{ $json.pg_map_contexto_20}}\nMensaje actual del usuario, util√≠zalo para determinar cada categor√≠a:\n{{ $('mensaje_usuario').item.json.mensaje }}","categories":{"categories":[{"category":"descuento","description":"Solicita descuento por volumen o condiciones especiales."},{"category":"spam","description":"=Act√∫as como un filtro de mensajes spam para un sistema de atenci√≥n al cliente de una gran empresa que recibe miles de mensajes al d√≠a por WhatsApp. Tu tarea es analizar cada mensaje de forma individual y decidir si es spam o no spam.  Considera como spam:  Publicidad no solicitada (ej.: \"Compra Bitcoin ahora\", \"Gana dinero f√°cil\", \"Ofertas exclusivas\", \"compra mis bitcoins\").  Es decir, cualquier mensaje que haga referencia a promociones de sus servicios si previamente no se ha preguntado por ello.  Mensajes autom√°ticos de bots externos que ofrecen servicios, ventas, citas, inversiones, etc.  Cadenas de mensajes virales, sorteos falsos, contenido enga√±oso o sospechoso. Mensajes con links sospechosos, especialmente si el mensaje no tiene relaci√≥n con los productos o servicios de la empresa.  Mensajes en otros idiomas que no tienen ninguna conexi√≥n aparente con las operaciones o mercados de la empresa.  Propuestas agresivas de ventas de terceros que no han sido solicitadas.  NO es spam (aunque el mensaje sea molesto o breve) si: El cliente est√° preguntando, quej√°ndose, saludando, confirmando, dando las gracias, o respondiendo a una conversaci√≥n previa.  El mensaje tiene aunque sea una m√≠nima relaci√≥n con los productos, servicios, soporte, dudas, facturaci√≥n, env√≠os, garant√≠as, devoluciones, o cualquier tema relevante para la empresa.  El mensaje es solo un saludo (\"hola\", \"buenas\"), aunque sea corto o repetido. A Importante: No asumas spam por el tono o longitud.  Clasifica como spam √∫nicamente si es claramente publicidad no deseada, mensaje automatizado irrelevante o contenido ajeno a las operaciones de la empresa. Determinalo tanto con el mensaje actual:  \"{{ $('mensaje_usuario').item.json.mensaje }}\" como con los mensajes anteriores que el usuario envi√≥:  \"{{ $json.pg_map_contexto_20 }}\""},{"category":"insistencia","description":"=El cliente responde o agradece, pero sin presionar ni reclamar. Hay solo un mensaje, o los mensajes son distantes en el tiempo sin signos de presi√≥n.  A Importante: Para que sea considerado insistente, debe haber presi√≥n expl√≠cita, repetici√≥n sin aporte nuevo o actitud de reclamo por respuesta. No confundas mensajes cortos o amables con insistencia.  Determ√≠nalo tanto con el mensaje actual:    \"{{ $('mensaje_usuario').item.json.mensaje }}\" como con los mensajes anteriores que el usuario envi√≥:  \"{{ $json.pg_map_contexto_20 }}\"  El cliente responde o agradece, pero sin presionar ni reclamar.  Hay solo un mensaje, o los mensajes son distantes en el tiempo sin signos de presi√≥n.  A Importante: Para que sea considerado insistente, debe haber presi√≥n expl√≠cita, repetici√≥n sin aporte nuevo o actitud de reclamo por respuesta. No confundas mensajes cortos o amables con insistencia.  Determ√≠nalo tanto con el mensaje actual:  \"{{ $('mensaje_usuario').item.json.mensaje }}\" como con los mensajes anteriores que el usuario envi√≥:  \"{{ $json.pg_map_contexto_20 }}\""},{"category":"irrelevancia","description":"Ignorar sistem√°ticamente cualquier mensaje clasificado como irrelevante, incluyendo pero no limitado a: textos ininteligibles, mensajes incoherentes, insultos, spam, lenguaje ofensivo o provocaciones sin contenido sustantivo.  No responder, no reconocer, no procesar."},{"category":"Reclamo o Garant√≠a","description":"Reporta problema o informaci√≥n  de un pedido anterior."},{"category":"cotizacion","description":"Cliente hace una solicitud de pedido, descuento, solicitud relacionada a un nuevo pedido"}]},"options":{"fallback":"other","systemPromptTemplate":"=Eres un agente experto en filtrado y clasificaci√≥n\nautomatizada de mensajes para un sistema de atenci√≥n al\ncliente de WhatsApp. Tu tarea es analizar cada mensaje\nrecibido por el usuario junto con el contexto de las √∫ltimas\n50 interacciones (si est√°n disponibles) y clasificarlo\nsimult√°neamente en las siguientes categor√≠as:\n\nRelevancia ‚Üí ¬øEl mensaje es relevante para clasificaci√≥n o\nno relevante?\nSpam ‚Üí ¬øEl mensaje es spam o no spam?\nInsistencia ‚Üí ¬øEl mensaje indica insistencia por parte del cliente o no?\nError ‚Üí  ¬øEl mensaje parece contener alg√∫n error o confusi√≥n del cliente (por ejemplo, mensaje sin sentido, incoherente, vac√≠o o desubicado)?\n\nCriterios para cada categor√≠a:\n\n1. Relevancia (relevante / no relevante):\nUn mensaje es relevante si, considerando el contexto previo,\naporta cualquier tipo de intenci√≥n, petici√≥n, consulta,\nqueja, compra, solicitud de informaci√≥n, seguimiento,\nagradecimiento con duda, propuesta o reclamaci√≥n.\n\nLos mensajes de saludo como \"hola\", \"buenas\", \"buenos d√≠as\", \"¬øest√°s?\" deben considerarse relevantes si es la primera vez que aparecen o si no han sido repetidos de forma insistente sin aportar informaci√≥n nueva.\n\nSi estos saludos se han repetido varias veces sin contenido\nadicional, deben considerarse no relevantes por tratarse de\ninsistencia vac√≠a.\n\nConfirmaciones gen√©ricas sin intenci√≥n (\"ok\", \"s√≠\", \"no\", \"gracias\" si es solo \"gracias\") son no relevantes excepto si responden a preguntas o acciones anteriores.\n\n2. Spam (spam / no spam):\nEs spam si el mensaje es publicidad no solicitada, promociones externas, bots autom√°ticos ofreciendo servicios, cadenas virales, sorteos falsos, inversiones tipo \"compra Bitcoin\" o cualquier contenido ajeno a la actividad de la empresa.\n\nNo es spam si el cliente est√° preguntando, quej√°ndose, saludando, confirmando o interactuando con alg√∫n tema relacionado con los productos, servicios o soporte de la empresa.\n\n3. Insistencia (insistente / no insistente):\nEs insistente si el cliente repite la misma solicitud, pregunta o reclamo varias veces seguidas sin recibir respuesta o sin aportar nueva informaci√≥n.\n\nEjemplos: \"¬øme pueden ayudar?\", \"llevo esperando\", \"¬øhay alguien ah√≠?\", \"¬øpueden responder?\".\nNo es insistencia si el cliente aporta informaci√≥n nueva, pregunta por temas distintos o hay tiempo suficiente entre mensajes sin presi√≥n.\n4. Error (error / no error):\nMarca como error si el mensaje es incoherente, vac√≠o, mal formulado, contiene solo s√≠mbolos o palabras sin sentido, o si claramente el cliente parece confundido sobre con qui√©n est√° hablando.\nNo marques como error si el mensaje, aunque corto, tiene sentido dentro del contexto.\n\nInstrucciones clave:\nDeterm√≠nalo siempre tanto con el mensaje actual:\n{{ $('mensaje_usuario').item.json.mensaje }}\ncomo con los mensajes anteriores enviados por el usuario. \n\nNo interpretes emociones. No confundas spam con insistencia, ni error con no relevancia. Cada categor√≠a debe evaluarse de forma independiente. "}},"type":"@n8n/n8n-nodes-langchain.textClassifier","typeVersion":1.1,"position":[-1168,3072],"id":"dbc766f5-0d38-476a-a82c-cf3280c27c1e","name":"Filtro tipo de conversaci√≥n1","alwaysOutputData":false},{"parameters":{"inputText":"=Mensaje actual del usuario, util√≠zalo para determinar cada categor√≠a:\n{{ $('Valores rapidos').item.json.mensaje }}\n\n√öltimas 20 conversaciones con el usuario (contexto): {{$('pg_map_contexto_20').item.json.pg_map_contexto_20.toJsonString()}}","categories":{"categories":[{"category":"pedido","description":"El cliente menciona uno o m√°s productos, cantidades o expresa intenci√≥n clara de pedir/cotizar/pagar algo en el historial"},{"category":"informacion","description":" El cliente pide datos generales: saludo, horarios, m√©todos de pago, estado de pedido, ubicaci√≥n, etc., pero no lista productos."},{"category":"reclamo","description":"El cliente expresa insatisfacci√≥n, enojo o hace un reclamo por un pedido, servicio o entrega."},{"category":"humano","description":"El cliente pide expl√≠citamente solicita atenci√≥n de un humano."}]},"options":{"fallback":"other","systemPromptTemplate":"=Act√∫as como un Text Classifier experto en servicio al cliente.\nDebes clasificar cada mensaje en **exactamente una** de estas categor√≠as:\n\n1. **pedido** ‚Üí El cliente menciona uno o m√°s productos, cantidades o expresa intenci√≥n clara de pedir/cotizar algo.\n2. **informacion** ‚Üí El cliente pide datos generales: horarios, m√©todos de pago, estado de pedido, ubicaci√≥n, etc., pero no lista productos o cotizaciones.\n3. **reclamo** ‚Üí El cliente expresa insatisfacci√≥n, enojo o hace un reclamo por un pedido, servicio o entrega.\n4. **hablar con humano** ‚Üí El cliente pide expl√≠citamente hablar con un humano.\n\n### Reglas:\n- Si hay duda entre dos categor√≠as, elige **pedido** si hay productos mencionados.\n- Si hay lenguaje de queja o enojo, elige **reclamo** incluso si pide informaci√≥n.\n- Si el mensaje est√° vac√≠o o es incoherente, clasifica como **informacion**.\n\nDevuelve √∫nicamente el nombre de la categor√≠a como texto plano.\n\nInstrucciones clave:\nDeterm√≠nalo siempre tanto con el mensaje actual:\n{{ $('Valores rapidos').item.json.mensaje }}\ncomo con los mensajes anteriores enviados por el usuario.  {{ $json.pg_map_contexto_20[0] }}\n"}},"type":"@n8n/n8n-nodes-langchain.textClassifier","typeVersion":1.1,"position":[-368,1616],"id":"bd416a76-cdef-48c3-8c71-c4f4bddb9e8e","name":"intenci√≥n","alwaysOutputData":false},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-400,1968],"id":"0998f268-417e-4da0-9d7e-3ece352e7f99","name":"OpenAI Chat Model1"},{"parameters":{"jsonSchemaExample":"{\n  \"mensaje\": \"Texto breve y directo con la informaci√≥n consultada\"\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[400,240],"id":"8bec7034-ba14-48bf-be42-66aa99cf7be8","name":"Structured Output Parser1"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[448,384],"id":"3ae3764c-edc6-4814-b483-5a7f0a9c5ecd","name":"OpenAI Chat Model2"},{"parameters":{"promptType":"define","text":"=Mensaje actual del usuario, util√≠zalo para determinar cada categor√≠a: \n{{ $('mensaje_usuario').item.json.mensaje }}\n\n{{ $json.message.text }} {{ $json.chatInput }}\n","hasOutputParser":true,"options":{"systemMessage":"=Eres un agente de atenci√≥n al cliente de una droguer√≠a especializado en responder preguntas frecuentes sobre horarios, servicios y pol√≠ticas de la droguer√≠a usando una base de conocimiento como fuente de conocimiento.\n\nAntes de consultar la base de conocimiento, analiza si el mensaje es un simple saludo o intenci√≥n social (ej. ‚Äúhola‚Äù, ‚Äúbuenas tardes‚Äù, ‚Äú¬øhay alguien?‚Äù).\nEn esos casos, responde con un saludo amable y ofrece ayuda en formato json sin a√±adir output al json:\n\nEjemplo:\nEntrada:\n\nhola\n\n\nRespuesta:\n\n{\n  \"mensaje\": \"¬°Hola! üëã Bienvenido a Droguer√≠a Hidmedimport. ¬øEn qu√© puedo ayudarte hoy?\"\n}\n\nüéØ Objetivo\n\nTu tarea es responder √∫nicamente si encuentras una coincidencia de alta similitud en la base de datos. Nunca inventes ni supongas informaci√≥n.\n\nüõ†Ô∏è Herramienta\n\nTienes acceso a una base de conocimiento (Info negocio) que contiene informaci√≥n exacta sobre:\n\nHorarios de atenci√≥n\n\nM√©todos de pago aceptados\n\nUbicaci√≥n de la droguer√≠a\n\nDisponibilidad de estacionamiento\n\nPol√≠ticas de atenci√≥n y entrega\n\nInformaci√≥n de contacto\n\n\n\nüìã Reglas estrictas\n\nSolo responde si la coincidencia es de alta relevancia. Si la similitud es baja, no inventes.\n\nSi encuentras coincidencia relevante, responde con un mensaje breve, claro y profesional.\n\nSi no hay coincidencia confiable, responde de forma neutra y cort√©s:\n\n{\n  \"mensaje\": \"Lo siento, no tengo informaci√≥n exacta sobre eso en este momento. ¬øTe gustar√≠a que lo consulte con un agente humano?\"\n}\n\n\nNunca combines m√∫ltiples resultados ni rellenes informaci√≥n faltante. Cada respuesta debe basarse en una √∫nica fuente.\n\nüßæ Formato de salida\n\nSiempre responde en JSON v√°lido:\n\n{\n  \"mensaje\": \"Texto breve y directo con la informaci√≥n consultada\"\n}\n\n‚úÖ Ejemplos de consultas esperadas\n\n‚Äú¬øHasta qu√© hora atienden los domingos?‚Äù\n\n‚Äú¬øD√≥nde queda la droguer√≠a?‚Äù\n\n‚Äú¬øAceptan pagos con tarjeta?‚Äù\n\n‚Äú¬øTienen estacionamiento?‚Äù\n\n‚Äú¬øCu√°l es su n√∫mero de contacto?‚Äù\n\nHoy es Fecha y hora: {{$now.toLocaleString(\"es-PE\", { weekday: \"long\", year: \"numeric\", month: \"2-digit\", day: \"2-digit\", hour: \"2-digit\", minute: \"2-digit\" })}}\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[128,96],"id":"68393a54-137f-42a1-beb9-6eab24c21d5d","name":"Infomaci√≥n","notesInFlow":false,"retryOnFail":true,"maxTries":2,"alwaysOutputData":true,"waitBetweenTries":5000},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('mensaje_usuario').item.json.telefono }}","tableName":"n8n_chat_historias"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[208,320],"id":"9285764b-e2a6-415f-92d1-4c5b8159ebbf","name":"Postgres Chat Memory1"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[96,288],"id":"1bd543f7-2b8c-48a2-b75b-df5f0f4bc432","name":"OpenAI Chat Model3"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/document","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"to\": \"{{ $('Webhook').item.json.body.messages[0].from }}\",\n  \"media\": \"{{ $json.url }}\",\n  \"mime_type\": \"application/pdf\",\n  \"caption\": \"\",\n\"filename\": \"cotizacion-hidmedic-{{$now.toLocaleString('es-PE', { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })}}.pdf\"\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4192,1520],"id":"df87281a-49ad-44b7-acf1-21824a9c1260","name":"enviar pdf"},{"parameters":{"assignments":{"assignments":[{"id":"69859c0d-0689-4fb3-811a-f51e3aa369c5","name":"url","value":"={{ $json.document_card.download_url }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3824,1520],"id":"801d851d-9512-434c-97ae-88e0dd0b6cd1","name":"link"},{"parameters":{"promptType":"define","text":"={{ $json.output.mensaje }}{{ $json.mensaje }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"Devuelve el mensaje en 1, 2 o 3 partes solo si es estrictamente necesario, procurando que sean la menor cantidad posible. Divide el texto √∫nicamente cuando resulte indispensable, de forma que parezca algo hecho por un humano (no perfecto, pero natural)."}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[1920,512],"id":"2456469d-65d4-4b56-b465-ffdc8956b1a0","name":"Basic LLM Chain"},{"parameters":{"jsonSchemaExample":"{\n  \"Response\": {\n    \"Parte1\": \"Primera parte del mensaje\",\n    \"Parte2\": \"Segunda parte del mensaje\",\n    \"Parte3\": \"Tercera parte del mensaje\"\n  }\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[2224,736],"id":"21f9ffeb-58e7-4fd5-9f03-f226088e737f","name":"Structured Output Parser2"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1968,800],"id":"8bd11e84-e6b1-45b1-96e7-89729b90b6d2","name":"OpenAI Chat Model4"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bd5ed21d-5d04-4ed7-8f5d-639f92964855","leftValue":"={{ $json.output.Response.Parte1 }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2224,400],"id":"4568cb5a-4efb-4622-9c50-3ce12274e877","name":"If2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a926b44e-6302-4aba-a5de-70383966cfc7","leftValue":"={{ $json.output.Response.Parte1 }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2608,416],"id":"065aef9e-ac3c-4d39-8c19-1a5ace8dd804","name":"If3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0117ea8e-e098-4645-94bd-e8ca280b3894","leftValue":"={{ $json.output.Response.Parte3 }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2976,480],"id":"84ec0389-a54c-4612-9065-0a7f17f050e1","name":"If4"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"to","value":"={{ $('Webhook').item.json.body.messages[0].from }}"},{"name":"body","value":"={{ $json.output.Response.Parte1 }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2496,144],"id":"bbe9e042-4306-4828-86b1-cbbd0544d127","name":"TEXTO2"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"to","value":"={{ $('Webhook').item.json.body.messages[0].from }}"},{"name":"body","value":"={{ $json.output.Response.Parte2 }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2752,304],"id":"1c130f58-dc09-4555-9a15-f97192bba945","name":"TEXTO3"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"to","value":"={{ $('Webhook').item.json.body.messages[0].from }}"},{"name":"body","value":"={{ $json.output.Response.Parte3 }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3184,464],"id":"e7c09476-fc2f-42c4-adb5-4a90ef1af158","name":"TEXTO4"},{"parameters":{"jsCode":"// Convierte el string JSON del campo \"data\" en items individuales\nconst arr = JSON.parse($json.data);  // [{codigo:\"FTT1318\", cantidad:3}, ...]\nreturn arr.map(row => ({ json: row }));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2528,1440],"id":"de7b6210-ebe5-4262-9e44-1b898d2c36d1","name":"formatear json de productos"},{"parameters":{"operation":"executeQuery","query":"WITH codes AS (\n  SELECT jsonb_array_elements_text($1::jsonb) AS codigo_txt\n)\nSELECT DISTINCT p.*\nFROM inventario4 p\nJOIN codes c\n  ON p.codigo = c.codigo_txt;\n","options":{"queryReplacement":"={{ JSON.stringify(JSON.parse($('productos ai').item.json.data).map(i => i.codigo)) }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2528,1696],"id":"c72dd2e2-2278-4a56-a9c6-42a8efe8bb10","name":"Crear arreglo de codigo de productos"},{"parameters":{"mode":"combine","fieldsToMatchString":"=codigo","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2848,1520],"id":"0de1863d-4b42-441f-926d-f9e7ef856014","name":"Info de productos confiable","alwaysOutputData":false},{"parameters":{"authentication":"airtableOAuth2Api","operation":"create","base":{"__rl":true,"value":"appY6ccYMnwAtjduc","mode":"list","cachedResultName":"Usuarios","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc"},"table":{"__rl":true,"value":"tblBRdtenmbkWoiAl","mode":"list","cachedResultName":"Table 1","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc/tblBRdtenmbkWoiAl"},"columns":{"mappingMode":"defineBelow","value":{"Nombre":"={{ $('Valores rapidos').item.json.nombre }}","Whatsapp number":"={{ $('Valores rapidos').item.json.telefono }}","Estado":"Usuario nuevo"},"matchingColumns":[],"schema":[{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Whatsapp number","displayName":"Whatsapp number","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Notes","displayName":"Notes","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Assignee","displayName":"Assignee","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Estado","displayName":"Estado","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"options","options":[{"name":"Usuario nuevo","value":"Usuario nuevo"},{"name":"Cotizaci√≥n enviada","value":"Cotizaci√≥n enviada"},{"name":"Cotizaci√≥n sin confirmar","value":"Cotizaci√≥n sin confirmar"},{"name":"Cotizaci√≥n confirmada","value":"Cotizaci√≥n confirmada"},{"name":"Pendiente de pago / Seguimiento","value":"Pendiente de pago / Seguimiento"},{"name":"Pago verificado","value":"Pago verificado"},{"name":"Pedido entregado","value":"Pedido entregado"}],"readOnly":false,"removed":false},{"id":"Attachments","displayName":"Attachments","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"array","readOnly":false,"removed":false},{"id":"Attachment Summary","displayName":"Attachment Summary","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.airtable","typeVersion":2.1,"position":[-2384,2048],"id":"fedf04f9-721b-4f74-a281-43bab4a45b1b","name":"Create a record"},{"parameters":{"content":"# No es mensaje propio,","height":756,"width":672,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-8096,1232],"id":"93dd53f6-47b5-4db3-9a40-d6ab5dc8326a","name":"Sticky Note5"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"552dfedf-aba2-4ad8-8392-0c836c9397ae","leftValue":"={{ $json.body.messages[0].from_me }}","rightValue":"true","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7760,1488],"id":"031b265d-61c1-4035-8217-85a6e99a4225","name":"Mis propios mensajes?"},{"parameters":{"content":"# Analizar diferentes tipos de mensajes ","height":1092,"width":1872,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-6624,1040],"id":"b4c77043-ebbc-410b-9b13-744a80a3c60e","name":"Sticky Note7"},{"parameters":{"content":"## Verificar intencionalidad\n**Double click** to edit me. [Guide](https://docs.n8n.io/workflows/sticky-notes/)","height":784,"width":528,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-464,1440],"typeVersion":1,"id":"53f3fe0c-6c68-4956-a51a-7a5c60341ec5","name":"Sticky Note8"},{"parameters":{"content":"## Genera error (backup)\n**Double click** to edit me. [Guide](https://docs.n8n.io/workflows/sticky-notes/)","height":672,"width":816,"color":5},"type":"n8n-nodes-base.stickyNote","position":[0,0],"typeVersion":1,"id":"e27f76a1-74c0-4a56-8d00-4b150a0e9918","name":"Sticky Note9"},{"parameters":{"content":"## Agente cotizador\n** ","height":1024,"width":1440,"color":3},"type":"n8n-nodes-base.stickyNote","position":[400,1136],"typeVersion":1,"id":"0da0767e-c6d3-48e4-9611-7c6cf5de347e","name":"Sticky Note10"},{"parameters":{"content":"## Hablar con humano","height":432,"width":928,"color":5},"type":"n8n-nodes-base.stickyNote","position":[4640,2688],"typeVersion":1,"id":"6915d625-e68b-4e03-88cf-a8dace4ba58b","name":"Sticky Note"},{"parameters":{"content":"## Enviar mensajes a whatsapp","height":720,"width":1728,"color":4},"type":"n8n-nodes-base.stickyNote","position":[1744,224],"typeVersion":1,"id":"209d0438-8ec7-44dd-9ba6-f00bd3a67650","name":"Sticky Note1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"a3d4286f-712f-4460-9afc-c7ea58d9732d","leftValue":"={{ Object.keys($json).length }}","rightValue":"=0","operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2576,1664],"id":"50214dde-368f-48c6-8e63-eda692929be2","name":"¬øExiste en la bd?"},{"parameters":{"content":"# Buscar o crear en la bd","height":756,"width":688,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-3024,1296],"id":"dfa80ccc-e718-420a-a088-0887a6482fd5","name":"Sticky Note12"},{"parameters":{"authentication":"airtableOAuth2Api","operation":"search","base":{"__rl":true,"value":"appY6ccYMnwAtjduc","mode":"list","cachedResultName":"Usuarios Hidmed Import ","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc"},"table":{"__rl":true,"value":"tblBRdtenmbkWoiAl","mode":"list","cachedResultName":"Table 1","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc/tblBRdtenmbkWoiAl"},"filterByFormula":"={Whatsapp number} = {{ $json.telefono }}","options":{}},"type":"n8n-nodes-base.airtable","typeVersion":2.1,"position":[-2720,1456],"id":"be71534c-17b8-4eb4-9a4a-c74976c90a73","name":"buscar usuario en bd","alwaysOutputData":true},{"parameters":{"assignments":{"assignments":[{"id":"35e1061d-69e7-4800-a6ab-42de43f71524","name":"telefono","value":"={{ $('Webhook').item.json.body.messages[0].from }}","type":"string"},{"id":"3faa58fb-b3fd-443e-83df-45c1d542806f","name":"mensaje","value":"={{ $('Mensaje completo').item.json.response }}","type":"string"},{"id":"407c208c-ea5b-43f3-85e6-9ee3dd438754","name":"nombre","value":"={{ $('Webhook').item.json.body.messages[0].from_name }}","type":"string"},{"id":"2b570170-8148-421e-a673-e4b071971f3f","name":"type","value":"={{ $('Webhook').item.json.body.messages[0].type }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3088,1648],"id":"8e7e9d04-1408-414a-81c1-98a5c40b7f2b","name":"Valores rapidos"},{"parameters":{"authentication":"airtableOAuth2Api","operation":"update","base":{"__rl":true,"value":"appY6ccYMnwAtjduc","mode":"list","cachedResultName":"Usuarios","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc"},"table":{"__rl":true,"value":"tblBRdtenmbkWoiAl","mode":"list","cachedResultName":"Table 1","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc/tblBRdtenmbkWoiAl"},"columns":{"mappingMode":"defineBelow","value":{"Whatsapp number":"={{ $('Valores rapidos').item.json.telefono }}","Estado":"Cotizaci√≥n confirmada"},"matchingColumns":["Whatsapp number"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"string","readOnly":true,"removed":true},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true},{"id":"Whatsapp number","displayName":"Whatsapp number","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Notes","displayName":"Notes","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true},{"id":"Assignee","displayName":"Assignee","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true},{"id":"Estado","displayName":"Estado","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"options","options":[{"name":"Usuario nuevo","value":"Usuario nuevo"},{"name":"Cotizaci√≥n enviada","value":"Cotizaci√≥n enviada"},{"name":"Cotizaci√≥n sin confirmar","value":"Cotizaci√≥n sin confirmar"},{"name":"Cotizaci√≥n confirmada","value":"Cotizaci√≥n confirmada"},{"name":"Pendiente de pago / Seguimiento","value":"Pendiente de pago / Seguimiento"},{"name":"Pago verificado","value":"Pago verificado"},{"name":"Pedido entregado","value":"Pedido entregado"},{"name":"Hablar con un humano","value":"Hablar con un humano"}],"readOnly":false,"removed":false},{"id":"Attachments","displayName":"Attachments","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"array","readOnly":false,"removed":true},{"id":"Attachment Summary","displayName":"Attachment Summary","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.airtable","typeVersion":2.1,"position":[5248,1520],"id":"97a65ddc-3a22-438b-a64c-5dfd4944a40f","name":"Update record"},{"parameters":{"method":"POST","url":"=https://gate.whapi.cloud/labels/9/{{ $('Valores rapidos').item.json.telefono}}@s.whatsapp.net","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4944,1536],"id":"c1c4e591-06f6-4993-afeb-70078f23945e","name":"A√±adir etiqueta humano","alwaysOutputData":false,"disabled":true,"onError":"continueErrorOutput"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"to","value":"={{ $('Valores rapidos').item.json.telefono }}"},{"name":"body","value":"=Hemos derivado tu pedido al √°rea de facturaci√≥n üßë‚Äçüíª. Por favor, espera unos minutos mientras revisamos tu caso."}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5520,1504],"id":"dab79e19-f373-4848-b708-59abd1fbc379","name":"TEXTO5"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[5264,1728],"id":"ce63246b-c747-4eb2-af93-7d08f0f144d9","name":"No Operation, do nothing5"},{"parameters":{"content":"## Registrar estado de pedido confirmado","height":656,"width":1488,"color":4},"type":"n8n-nodes-base.stickyNote","position":[4576,1216],"typeVersion":1,"id":"5efc2e90-709b-4195-9014-568826956104","name":"Sticky Note3"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"26a62946-8723-485a-bf4d-e5c35dd80cf1","leftValue":"={{ $('Switch').item.json.accion }}","rightValue":"conformidad","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"conformidad"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Switch').item.json.accion }}","rightValue":"no_conformidad","operator":{"type":"string","operation":"equals"},"id":"cc30063e-1c18-4d6e-9713-86d92198b6c1"}],"combinator":"and"},"renameOutput":true,"outputKey":"no_conformidad"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d3fcfd49-17dc-472d-bd66-bfe419b7e5bd","leftValue":"={{ $('Switch').item.json.accion }}","rightValue":"enviar_pdf","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"cotizaci√≥n"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[4400,1488],"id":"7e389e8a-7eee-4704-9776-95bde88e474c","name":"Switch1"},{"parameters":{"authentication":"airtableOAuth2Api","operation":"update","base":{"__rl":true,"value":"appY6ccYMnwAtjduc","mode":"list","cachedResultName":"Usuarios","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc"},"table":{"__rl":true,"value":"tblBRdtenmbkWoiAl","mode":"list","cachedResultName":"Table 1","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc/tblBRdtenmbkWoiAl"},"columns":{"mappingMode":"defineBelow","value":{"Whatsapp number":"={{ $('Valores rapidos').item.json.telefono }}","Estado":"Cotizaci√≥n sin confirmar"},"matchingColumns":["Whatsapp number"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"string","readOnly":true,"removed":true},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true},{"id":"Whatsapp number","displayName":"Whatsapp number","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Notes","displayName":"Notes","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true},{"id":"Assignee","displayName":"Assignee","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true},{"id":"Estado","displayName":"Estado","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"options","options":[{"name":"Usuario nuevo","value":"Usuario nuevo"},{"name":"Cotizaci√≥n enviada","value":"Cotizaci√≥n enviada"},{"name":"Cotizaci√≥n sin confirmar","value":"Cotizaci√≥n sin confirmar"},{"name":"Cotizaci√≥n confirmada","value":"Cotizaci√≥n confirmada"},{"name":"Pendiente de pago / Seguimiento","value":"Pendiente de pago / Seguimiento"},{"name":"Pago verificado","value":"Pago verificado"},{"name":"Pedido entregado","value":"Pedido entregado"},{"name":"Hablar con un humano","value":"Hablar con un humano"}],"readOnly":false,"removed":false},{"id":"Attachments","displayName":"Attachments","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"array","readOnly":false,"removed":true},{"id":"Attachment Summary","displayName":"Attachment Summary","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.airtable","typeVersion":2.1,"position":[5376,2016],"id":"a0feb17d-41eb-4bbf-8a6c-9c9ef299d02b","name":"Update record1"},{"parameters":{"method":"POST","url":"=https://gate.whapi.cloud/labels/9/{{ $('Valores rapidos').item.json.telefono }}@s.whatsapp.net","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5072,2032],"id":"7da64e02-2ffd-4b40-8775-1a5fdc18881b","name":"A√±adir etiqueta humano1","alwaysOutputData":false,"disabled":true,"onError":"continueErrorOutput"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"to","value":"={{ $('Valores rapidos').item.json.telefono }}"},{"name":"body","value":"=Hemos derivado tu caso al √°rea de facturaci√≥n üßë‚Äçüíª. Por favor, espera unos minutos mientras revisamos tu caso."}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5648,2000],"id":"a59190ab-c9a1-4876-a1c7-55f9136b7f0c","name":"TEXTO6"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[5392,2224],"id":"0c7f20f0-bc45-4822-b24d-752187eadd8b","name":"No Operation, do nothing6"},{"parameters":{"content":"## Registrar estado de pedido no conformidad","height":656,"width":1488,"color":3},"type":"n8n-nodes-base.stickyNote","position":[4544,1936],"typeVersion":1,"id":"4f379f68-e7df-4f78-8e7e-4696e5128d09","name":"Sticky Note13"},{"parameters":{"authentication":"airtableOAuth2Api","operation":"update","base":{"__rl":true,"value":"appY6ccYMnwAtjduc","mode":"list","cachedResultName":"Usuarios","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc"},"table":{"__rl":true,"value":"tblBRdtenmbkWoiAl","mode":"list","cachedResultName":"Table 1","cachedResultUrl":"https://airtable.com/appY6ccYMnwAtjduc/tblBRdtenmbkWoiAl"},"columns":{"mappingMode":"defineBelow","value":{"Whatsapp number":"={{ $('Valores rapidos').item.json.telefono }}","Estado":"Cotizaci√≥n enviada"},"matchingColumns":["Whatsapp number"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"string","readOnly":true,"removed":true},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true},{"id":"Whatsapp number","displayName":"Whatsapp number","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":false},{"id":"Notes","displayName":"Notes","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true},{"id":"Assignee","displayName":"Assignee","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true},{"id":"Estado","displayName":"Estado","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"options","options":[{"name":"Usuario nuevo","value":"Usuario nuevo"},{"name":"Cotizaci√≥n enviada","value":"Cotizaci√≥n enviada"},{"name":"Cotizaci√≥n sin confirmar","value":"Cotizaci√≥n sin confirmar"},{"name":"Cotizaci√≥n confirmada","value":"Cotizaci√≥n confirmada"},{"name":"Pendiente de pago / Seguimiento","value":"Pendiente de pago / Seguimiento"},{"name":"Pago verificado","value":"Pago verificado"},{"name":"Pedido entregado","value":"Pedido entregado"},{"name":"Hablar con un humano","value":"Hablar con un humano"}],"readOnly":false,"removed":false},{"id":"Attachments","displayName":"Attachments","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"array","readOnly":false,"removed":true},{"id":"Attachment Summary","displayName":"Attachment Summary","required":false,"defaultMatch":false,"canBeUsedToMatch":true,"display":true,"type":"string","readOnly":false,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.airtable","typeVersion":2.1,"position":[5152,752],"id":"aeee435e-bf9b-4404-ab25-bb9ef6f0f2ca","name":"Update record2"},{"parameters":{"content":"## Registrar estado de cotizaci√≥n enviada","height":480,"width":1488,"color":5},"type":"n8n-nodes-base.stickyNote","position":[4512,608],"typeVersion":1,"id":"c7d7a218-524a-4160-b893-34e479887df4","name":"Sticky Note14"},{"parameters":{"operation":"get","propertyName":"mensajes","key":"={{ $('Webhook').item.json.body.messages[0].from }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4128,1584],"id":"874e567f-cc74-4d2b-aeb4-fd0717523f2e","name":"Redis6"},{"parameters":{"operation":"push","list":"={{ $('Webhook').item.json.body.messages[0].from }}","messageData":"={{ $('Merge').item.json.mensaje || \" \" }}","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-4512,1584],"id":"8bcacdfa-f81b-47d8-9f5d-c3313330b955","name":"Redis7"},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8a313a41-eadc-4ada-bc2a-feff79845de9","leftValue":"={{ $json.mensajes && $json.mensajes.length > 0 ? $json.mensajes.last() : \" \" }}","rightValue":"={{ $('Redis7').item.json.mensaje[0] }}","operator":{"type":"string","operation":"equals"}},{"id":"edaf73d2-0650-463a-93cc-cc884d9e013c","leftValue":"={{ $('Redis7').item.json.mensaje[0] }}","rightValue":"","operator":{"type":"string","operation":"notExists","singleValue":true}}],"combinator":"or"},"options":{"ignoreCase":true}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3920,1584],"id":"a1e52c15-51b0-454f-901b-7b57429595b6","name":"If6"},{"parameters":{"assignments":{"assignments":[{"id":"d5f82380-4858-4361-908e-98e45c98f092","name":"response","value":"={{ $('Redis6').item.json.mensajes.join() }}","type":"string"},{"id":"b3db797c-6f2b-4232-8e0c-021bc8e299ca","name":"phone","value":"={{ $('Webhook').item.json.body.messages[0].from }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3696,1568],"id":"bb297a76-4132-4a42-b137-2f495a96564f","name":"Edit Fields2"},{"parameters":{"operation":"delete","key":"={{ $('Webhook').item.json.body.messages[0].from }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3504,1456],"id":"5512aa17-dc13-457d-b90b-f6de0e22c710","name":"Redis9"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-3696,1776],"id":"092b28a3-b5b0-438e-ba2c-e59ac22c33ca","name":"No Operation, do nothing7"},{"parameters":{"content":"# Guardar mensajes sucesivos","height":756,"width":1408,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4544,1312],"id":"f61b10b3-01cf-4534-8c8e-66ba80a9000b","name":"Sticky Note15"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-3344,1664],"id":"ae9a676c-2929-4842-93e2-d65761ec16f4","name":"Mensaje completo"},{"parameters":{"amount":10},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-4304,1584],"id":"a172e525-23a8-4558-b8db-da7f5ccf7583","name":"5 segundos de espera","webhookId":"f77a22da-0e79-4547-b9f1-4a054831925d"},{"parameters":{"assignments":{"assignments":[{"id":"8b7e01d4-bd3b-45c6-9eba-f17cb4cbfe91","name":"mensaje","value":"={{ $('Webhook').item.json.body.messages[0].text.body }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5952,1840],"id":"4a603edb-b596-482e-98f4-155c9489a6dc","name":"texto"},{"parameters":{"assignments":{"assignments":[{"id":"0d1729a1-0e28-425e-a8c0-a7e945d919ec","name":"mensaje","value":"={{ $('pedido').item.json.pedido }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5280,1584],"id":"a11d1bea-bb52-47e3-a84f-a1ce63c9dafb","name":"texto de imagen"},{"parameters":{"assignments":{"assignments":[{"id":"0d1729a1-0e28-425e-a8c0-a7e945d919ec","name":"mensaje","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5568,1168],"id":"1153e3a4-aec4-4710-a922-f84fbea680bc","name":"texto de voz"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"to","value":"={{ $('Webhook').item.json.body.messages[0].from }}"},{"name":"body","value":"=Recibimos tu archivo pero no podemos leerlo porque no es un formato v√°lido.\nSolo podemos leer:\nüìù Texto escrito\nüé§ Mensaje de voz\nüì∑ Foto o imagen"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-6336,1840],"id":"fadfd5db-44fa-4f4a-9cfd-1066d7aea8f0","name":"Formato no valido"},{"parameters":{"content":"# No esta asignado a humano,","height":756,"width":624,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-7360,1264],"id":"aa12483a-2b75-4c01-9e1c-349953b41beb","name":"Sticky Note11"},{"parameters":{"url":"=https://gate.whapi.cloud/chats/{{ $('Webhook').item.json.body.messages[0].chat_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-7344,1536],"id":"17a5ce73-912d-4700-afa7-9709957c4c45","name":"obtener info chat tag","alwaysOutputData":false,"onError":"continueErrorOutput"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-6896,1872],"id":"5d635b96-38c9-4ab8-9c6e-d8ead3e6b005","name":"No Operation, do nothing4"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e9984993-b6dd-41b4-b9bf-aadaac97f53a","leftValue":"={{ $json.error.message }}","rightValue":"label association already exists","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-400,1184],"id":"9769cde0-7c5d-4d8d-a066-3b2560f78f91","name":"La etiqueta existe?1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-144,1248],"id":"a968962d-db11-4773-ac25-fe01663e9341","name":"No Operation, do nothing8"},{"parameters":{"method":"POST","url":"=https://gate.whapi.cloud/labels/10/{{ $('Webhook').item.json.body.messages[0].chat_id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"Content-Type","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-624,1104],"id":"3fe0f6d2-1542-4b51-8644-665983b6b7bd","name":"A√±adir etiqueta SPAM","alwaysOutputData":false,"onError":"continueErrorOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e9984993-b6dd-41b4-b9bf-aadaac97f53a","leftValue":"={{ $('Obtener la info de la empresa asociada').item.json.whapi_tag_human }}","rightValue":"9","operator":{"type":"string","operation":"equals"}},{"id":"f5bf84d8-5617-4784-8f3e-141ac45d0684","leftValue":"={{ $('Obtener la info de la empresa asociada').item.json.whapi_tag_spam }}","rightValue":"10","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{"ignoreCase":false}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7152,1728],"id":"a16472fa-96bf-47aa-a331-3af9dda79cd6","name":"etiqueta humano o spam?"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-6112,1728],"id":"997e71e7-8deb-4515-92b8-8bbd7fb12706","name":"OpenAI Chat Model5"},{"parameters":{"promptType":"define","text":"=El mensaje a procesar es:\n{{ $json.choices[0].message.content }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"Devuelve estrictamente un JSON v√°lido con exactamente estos tres campos:\n\n{\n  \"mensaje\": \"El usuario mand√≥ una imagen con productos para cotizar.\",\n  \"productos\": \"- 100 UND AEROCAMARA DE PLASTICO LACTANTE\\n- 100 UND AEROCAMARA DE PLASTICO PEDIATRICO\\n- 800 UND AGUJA DENTAL TIPO CARPULE DESCARTABLE N¬∞30 G X 1 IN\\n...\",\n  \"total_productos\": 34\n}\n\nReglas de Generaci√≥n\n\nmensaje: Frase breve que explique que el usuario mand√≥ una imagen con productos para cotizar.\n\ntexto_markdown: Lista de productos en formato markdown (usa - al inicio de cada l√≠nea), no omitir ning√∫n producto\nNo omitas ning√∫n producto, incluso si son muchos (30+).\ntotal_productos: N√∫mero total de l√≠neas/productos detectados. Debe ser un n√∫mero entero.\n\nIgnora l√≠neas que no sean productos (ej. hora, nombre de archivo, notas).\n\nNo devuelvas nada fuera del JSON.\n\nNo escapes saltos de l√≠nea con \\n, usa texto plano y deja que las l√≠neas se separen naturalmente.\n\nEjemplo de Salida Correcta para 4 productos\n{\n  \"mensaje\": \"El usuario mand√≥ una imagen con productos para cotizar.\",\n  \"texto_markdown\": \"- 100 UND AEROCAMARA DE PLASTICO LACTANTE\\n- 100 UND AEROCAMARA DE PLASTICO PEDIATRICO\\n- 800 UND AGUJA DENTAL TIPO CARPULE DESCARTABLE N¬∞30 G X 1 IN\\n- 30 UND APOSITO HIDROCOLOIDE EXTRAFINO 10 CM X 10 CM...\",\n  \"total_productos\": 4\n}"}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-5776,1520],"id":"d17777e8-8a57-442b-88df-b2b5c2760c3c","name":"Basic LLM Chain1"},{"parameters":{"jsonSchemaExample":"{\n  \"mensaje\": \"El usuario mand√≥ una imagen con productos para cotizar.\",\n  \"texto_markdown\": \"- 100 UND AEROCAMARA DE PLASTICO LACTANTE\\n- 100 UND AEROCAMARA DE PLASTICO PEDIATRICO\\n- 800 UND AGUJA DENTAL TIPO CARPULE DESCARTABLE N¬∞30 G X 1 IN\\n- 30 UND APOSITO HIDROCOLOIDE EXTRAFINO 10 CM X 10 CM\",\n  \"total_productos\": 4\n}","autoFix":true},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-5808,1712],"id":"37ccde34-8f45-447e-a3f2-b4dd652c7708","name":"Structured Output Parser3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fb0c3f6a-7a62-4586-bf8e-89498018a9ba","leftValue":"={{ $json.output.total_productos }}","rightValue":35,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-5472,1520],"id":"569f3c33-cd85-49be-8864-4dd6f6528ba3","name":"mas de 35 productos?"},{"parameters":{"assignments":{"assignments":[{"id":"16cad329-d309-4af4-b738-4f8244b7b2a5","name":"cantidad_maxima","value":"Se super√≥ la cantidad d m√°xima de pedidos que se pueden atender en simultaneo que es 34, env√≠a menos productos., ","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-5280,1408],"id":"8b0b4dae-62d1-4706-bcaf-d6b88ae025e4","name":"limite maximo"},{"parameters":{"inputText":"={{ $json.pedido }}","categories":{"categories":[{"category":"pedido","description":"El usuario env√≠a informaci√≥n relacionada a un pedido de productos"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.textClassifier","typeVersion":1.1,"position":[-6080,1520],"id":"a02675be-51ad-454b-935d-619e22c3188d","name":"Identificar pedido"},{"parameters":{"assignments":{"assignments":[{"id":"d5a9fa09-b240-46d8-8694-806fa292f1e0","name":"pedido","value":"={{ $json.content }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-6224,1520],"id":"473003d3-eb45-43f4-88ab-cfcec54dd65a","name":"pedido"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1","mode":"list","cachedResultName":"gpt-4.1"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[448,1808],"id":"2f2869d6-e675-4d8d-b4d5-9fbeff7ca676","name":"OpenAI Chat Model6"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Valores rapidos').item.json.telefono }}","tableName":"conversation"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[576,1888],"id":"771cd39d-2424-4ffd-b334-e477293a0bda","name":"Postgres Chat Memory"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[3024,1504],"id":"f6677349-ce8d-441a-833f-d38a7a787ff9","name":"Aggregate"},{"parameters":{"amount":1},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2432,384],"id":"186a1cbf-b0ac-484d-8aeb-c50f10ac0d82","name":"Wait2","webhookId":"54e1c992-513a-478f-b1cc-e50b22d6cc42"},{"parameters":{"amount":1},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2784,528],"id":"4b648325-5830-4c70-afdf-0761edcd0838","name":"Wait4","webhookId":"2e803d34-cd9d-4905-8841-dddb0ddd2619"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"company","mode":"list","cachedResultName":"company"},"where":{"values":[{"column":"whapi_id","value":"={{ $json.body.channel_id }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8176,1328],"id":"219f8931-53b6-4a66-b0b5-a466cadc664d","name":"Obtener la info de la empresa asociada"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"users","mode":"list","cachedResultName":"users"},"where":{"values":[{"column":"phone","value":"={{ $('Valores rapidos').item.json.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2864,1648],"id":"7cefaad6-6557-4819-a561-ef50a0e23776","name":"buscar usuario en bd1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"users","mode":"list","cachedResultName":"users"},"columns":{"mappingMode":"defineBelow","value":{"phone":"={{ $('Valores rapidos').item.json.telefono }}","company_id":"={{ $('Obtener la info de la empresa asociada').item.json.code }}","funnel_stage":"inicial"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"phone","displayName":"phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"company_id","displayName":"company_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"funnel_stage","displayName":"funnel_stage","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"conversation_url","displayName":"conversation_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"name","displayName":"name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"last_interaction_at","displayName":"last_interaction_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"created_at_human","displayName":"created_at_human","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"source","displayName":"source","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2368,1824],"id":"baf7cd03-bd93-4428-aeb0-49434eb77528","name":"Crear registro"},{"parameters":{"assignments":{"assignments":[{"id":"d2bc76f3-22e7-467d-9d6b-5fd29836e623","name":"id","value":"={{ $json.id }}","type":"string"},{"id":"010b7e3b-606b-45f7-a8eb-2bb4c2bac9be","name":"name","value":"={{ $json.name }}","type":"string"},{"id":"8e9480c4-87ee-437a-b796-84f03b91dbf3","name":"logo_link","value":"={{ $json.logo_link }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-8000,1424],"id":"f3e3abb5-0c96-4300-85f6-c52a27e7ee18","name":"info empresa"}],"connections":{"AI Agent":{"main":[[{"node":"productos ai","type":"main","index":0}]]},"HTTP Request2":{"main":[[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"HTTP Request3","type":"main","index":0}]]},"HTTP Request3":{"main":[[{"node":"link","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"AI Agent","type":"ai_outputParser","index":0}]]},"Switch":{"main":[[{"node":"formatear json de productos","type":"main","index":0},{"node":"Crear arreglo de codigo de productos","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}],[{"node":"Basic LLM Chain","type":"main","index":0}],[{"node":"Execute Workflow","type":"main","index":0}],[{"node":"Execute Workflow","type":"main","index":0}],[{"node":"formatear json de productos","type":"main","index":0},{"node":"Crear arreglo de codigo de productos","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"enviar pdf","type":"main","index":0}]]},"Info negocio":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0},{"node":"Infomaci√≥n","type":"ai_tool","index":0}]]},"Webhook":{"main":[[{"node":"Obtener la info de la empresa asociada","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"HTTP Request4","type":"main","index":0}],[{"node":"Analyze image","type":"main","index":0}],[{"node":"texto","type":"main","index":0}],[{"node":"Formato no valido","type":"main","index":0}]]},"OpenAI":{"main":[[{"node":"texto de voz","type":"main","index":0}]]},"HTTP Request4":{"main":[[{"node":"OpenAI","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Aggregate1","type":"main","index":0}]]},"Analyze image":{"main":[[{"node":"pedido","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"Redis7","type":"main","index":0}]]},"mensaje_usuario":{"main":[[{"node":"Filtro tipo de conversaci√≥n","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Structured Output Parser","type":"ai_languageModel","index":0}]]},"Base de datos inventario":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Think":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"productos ai":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Code4","type":"main","index":0}]]},"Wait3":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Code5":{"main":[[{"node":"TEXTO","type":"main","index":0}]]},"Telegram Trigger":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"If":{"main":[[],[{"node":"Loop Over Items","type":"main","index":0}]]},"Code4":{"main":[[{"node":"TEXTO","type":"main","index":0}]]},"When chat message received":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"pg_20":{"main":[[{"node":"Aggregate2","type":"main","index":0}]]},"Aggregate2":{"main":[[{"node":"pg_map_contexto_20","type":"main","index":0}]]},"pg_map_contexto_20":{"main":[[{"node":"mensaje_usuario","type":"main","index":0}]]},"gpt mini":{"ai_languageModel":[[{"node":"Filtro tipo de conversaci√≥n","type":"ai_languageModel","index":0}]]},"Filtro tipo de conversaci√≥n":{"main":[[{"node":"intenci√≥n","type":"main","index":0}],[{"node":"A√±adir etiqueta SPAM","type":"main","index":0}],[{"node":"Execute Workflow","type":"main","index":0}],[{"node":"A√±adir etiqueta SPAM","type":"main","index":0}],[{"node":"intenci√≥n","type":"main","index":0}]]},"TEXTO":{"main":[[{"node":"Wait3","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"intenci√≥n","type":"ai_languageModel","index":0}]]},"intenci√≥n":{"main":[[{"node":"AI Agent","type":"main","index":0}],[{"node":"AI Agent","type":"main","index":0}],[{"node":"Execute Workflow","type":"main","index":0}],[{"node":"Execute Workflow","type":"main","index":0}],[{"node":"AI Agent","type":"main","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"Infomaci√≥n","type":"ai_outputParser","index":0}]]},"OpenAI Chat Model2":{"ai_languageModel":[[{"node":"Structured Output Parser1","type":"ai_languageModel","index":0}]]},"Postgres Chat Memory1":{"ai_memory":[[{"node":"Infomaci√≥n","type":"ai_memory","index":0}]]},"OpenAI Chat Model3":{"ai_languageModel":[[{"node":"Infomaci√≥n","type":"ai_languageModel","index":0}]]},"Infomaci√≥n":{"main":[[{"node":"Switch","type":"main","index":0}]]},"enviar pdf":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"link":{"main":[[{"node":"Wait1","type":"main","index":0}]]},"Structured Output Parser2":{"ai_outputParser":[[{"node":"Basic LLM Chain","type":"ai_outputParser","index":0}]]},"OpenAI Chat Model4":{"ai_languageModel":[[{"node":"Basic LLM Chain","type":"ai_languageModel","index":0},{"node":"Structured Output Parser2","type":"ai_languageModel","index":0}]]},"Basic LLM Chain":{"main":[[{"node":"If2","type":"main","index":0}]]},"If2":{"main":[[{"node":"Wait2","type":"main","index":0},{"node":"TEXTO2","type":"main","index":0}]]},"If3":{"main":[[{"node":"TEXTO3","type":"main","index":0},{"node":"Wait4","type":"main","index":0}]]},"If4":{"main":[[{"node":"TEXTO4","type":"main","index":0}]]},"formatear json de productos":{"main":[[{"node":"Info de productos confiable","type":"main","index":0}]]},"Crear arreglo de codigo de productos":{"main":[[{"node":"Info de productos confiable","type":"main","index":1}]]},"Info de productos confiable":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Mis propios mensajes?":{"main":[[{"node":"No Operation, do nothing3","type":"main","index":0}],[{"node":"obtener info chat tag","type":"main","index":0}]]},"¬øExiste en la bd?":{"main":[[{"node":"pg_20","type":"main","index":0}],[{"node":"Crear registro","type":"main","index":0}]]},"Valores rapidos":{"main":[[{"node":"buscar usuario en bd1","type":"main","index":0}]]},"Update record":{"main":[[{"node":"TEXTO5","type":"main","index":0}]]},"A√±adir etiqueta humano":{"main":[[{"node":"Update record","type":"main","index":0}],[{"node":"No Operation, do nothing5","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"A√±adir etiqueta humano","type":"main","index":0}],[{"node":"A√±adir etiqueta humano1","type":"main","index":0}],[{"node":"Update record2","type":"main","index":0}]]},"Update record1":{"main":[[{"node":"TEXTO6","type":"main","index":0}]]},"A√±adir etiqueta humano1":{"main":[[{"node":"Update record1","type":"main","index":0}],[{"node":"No Operation, do nothing6","type":"main","index":0}]]},"Redis6":{"main":[[{"node":"If6","type":"main","index":0}]]},"Redis7":{"main":[[{"node":"5 segundos de espera","type":"main","index":0}]]},"If6":{"main":[[{"node":"Edit Fields2","type":"main","index":0}],[{"node":"No Operation, do nothing7","type":"main","index":0}]]},"Edit Fields2":{"main":[[{"node":"Redis9","type":"main","index":0}]]},"Redis9":{"main":[[{"node":"Mensaje completo","type":"main","index":0}]]},"5 segundos de espera":{"main":[[{"node":"Redis6","type":"main","index":0}]]},"Mensaje completo":{"main":[[{"node":"Valores rapidos","type":"main","index":0}]]},"texto":{"main":[[{"node":"Merge","type":"main","index":2}]]},"texto de imagen":{"main":[[{"node":"Merge","type":"main","index":1}]]},"texto de voz":{"main":[[{"node":"Merge","type":"main","index":0}]]},"obtener info chat tag":{"main":[[{"node":"etiqueta humano o spam?","type":"main","index":0}]]},"La etiqueta existe?1":{"main":[[{"node":"No Operation, do nothing8","type":"main","index":0}],[{"node":"No Operation, do nothing8","type":"main","index":0}]]},"A√±adir etiqueta SPAM":{"main":[[],[{"node":"La etiqueta existe?1","type":"main","index":0}]]},"etiqueta humano o spam?":{"main":[[{"node":"No Operation, do nothing4","type":"main","index":0}],[{"node":"Switch2","type":"main","index":0}]]},"OpenAI Chat Model5":{"ai_languageModel":[[{"node":"Identificar pedido","type":"ai_languageModel","index":0},{"node":"Basic LLM Chain1","type":"ai_languageModel","index":0},{"node":"Structured Output Parser3","type":"ai_languageModel","index":0}]]},"Basic LLM Chain1":{"main":[[{"node":"mas de 35 productos?","type":"main","index":0}]]},"Structured Output Parser3":{"ai_outputParser":[[{"node":"Basic LLM Chain1","type":"ai_outputParser","index":0}]]},"mas de 35 productos?":{"main":[[{"node":"limite maximo","type":"main","index":0}],[{"node":"texto de imagen","type":"main","index":0}]]},"limite maximo":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Identificar pedido":{"main":[[{"node":"Basic LLM Chain1","type":"main","index":0}]]},"pedido":{"main":[[{"node":"Identificar pedido","type":"main","index":0}]]},"OpenAI Chat Model6":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Aggregate":{"main":[[{"node":"HTTP Request2","type":"main","index":0}]]},"Wait2":{"main":[[{"node":"If3","type":"main","index":0}]]},"Wait4":{"main":[[{"node":"If4","type":"main","index":0}]]},"Obtener la info de la empresa asociada":{"main":[[{"node":"info empresa","type":"main","index":0}]]},"buscar usuario en bd1":{"main":[[{"node":"¬øExiste en la bd?","type":"main","index":0}]]},"Crear registro":{"main":[[{"node":"pg_20","type":"main","index":0}]]},"info empresa":{"main":[[{"node":"Mis propios mensajes?","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"0c4f5c2b-226c-4253-9361-74c06ad13be8","triggerCount":0,"tags":[{"createdAt":"2025-11-18T17:34:15.311Z","updatedAt":"2025-11-18T17:34:15.311Z","id":"c3imwBZ1mCiUQxbf","name":"santiagomu√±oz"},{"createdAt":"2025-11-18T17:34:15.304Z","updatedAt":"2025-11-18T17:34:15.304Z","id":"cyLS5rqdXVmmC5Lz","name":"danimed"},{"createdAt":"2025-11-18T17:34:15.285Z","updatedAt":"2025-11-18T17:34:15.285Z","id":"PYRkGn3IzKzPUoeM","name":"valisoso"},{"createdAt":"2025-11-10T17:52:47.997Z","updatedAt":"2025-11-10T17:52:47.997Z","id":"XBwwjnkaDrN3oI0V","name":"MAIN"}],"shared":[{"createdAt":"2025-11-20T18:17:54.888Z","updatedAt":"2025-11-20T18:17:54.888Z","role":"workflow:owner","workflowId":"4K2mCGsurDz3Eqoh","projectId":"hjSKGjfHqbYgbRJl","project":{"createdAt":"2025-11-20T16:08:16.301Z","updatedAt":"2025-11-20T17:01:47.741Z","id":"hjSKGjfHqbYgbRJl","name":"Presla Corp <svargas@presla.co>","type":"personal","icon":null,"description":null}}]}